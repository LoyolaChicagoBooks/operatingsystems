

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>IPC Topics &mdash; Operating Systems v0.9.2 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Virtual Memory" href="kernelmm.html" />
    <link rel="prev" title="Deadlock" href="deadlock.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Operating Systems
          

          
          </a>

          
            
            
              <div class="version">
                v0.9.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="meta.html">About the Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="processes.html">Introduction to Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="files-io.html">Files and I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="scheduling.html">Process/Thread Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="mutualexclusion.html">Mutual Exclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="deadlock.html">Deadlock</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">IPC Topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ipc-performance-hierarchy">IPC Performance Hierarchy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pipes">Pipes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">Pipes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pipes-linux">Pipes - Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pipes-context-switches">Pipes - Context Switches</a></li>
<li class="toctree-l2"><a class="reference internal" href="#named-pipes-fifos">Named Pipes / FIFOs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-usage-of-a-regular-pipe-in-linux">Example usage of a regular pipe in Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="#named-pipes-common-usages">Named Pipes - Common Usages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#named-pipes-atomic-reads-writes">Named Pipes - Atomic Reads / Writes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#signals">Signals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#list-of-important-signals">List of Important Signals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#handling-signals-example">Handling Signals - Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sending-signals-example">Sending Signals - Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#signals-interrupted-system-calls">Signals - Interrupted System Calls</a></li>
<li class="toctree-l2"><a class="reference internal" href="#signals-reentrant-functions">Signals - Reentrant Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">Signals - Reentrant Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#signals-sending-in-code">Signals - Sending In Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-implementing-sleep-with-alarm">Example - implementing sleep() with alarm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-better-sleep-implementation">Example - “better” sleep implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#demonstrating-the-sleepfor-problem">Demonstrating the sleepFor problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#history-of-sleep-and-why-signals-are-scary">History of sleep and why signals are scary.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#other-uses-for-alarm">Other uses for alarm(…)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#memory-mapped-files">Memory Mapped Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">Memory Mapped Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id4">Memory Mapped Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#memory-mapped-files-virtual-addresses">Memory Mapped Files - Virtual Addresses</a></li>
<li class="toctree-l2"><a class="reference internal" href="#absolute-memory-addressing">Absolute Memory Addressing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#relative-memory-addressing">Relative Memory Addressing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#linux-minix-use-of-mmap">Linux / Minix - Use of mmap()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mmap-simple-example">mmap - simple example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id5">mmap - simple example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#memory-mapped-files-atomicity">Memory Mapped Files - Atomicity</a></li>
<li class="toctree-l2"><a class="reference internal" href="#memory-mapped-files-bounded-buffer">Memory Mapped Files - Bounded Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id6">Memory Mapped Files - Bounded Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id7">Memory Mapped Files - Bounded Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id8">Memory Mapped Files - Bounded Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id9">Memory Mapped Files - Bounded Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id10">Memory Mapped Files - Bounded Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#memory-mapped-files-fast-i-o">Memory Mapped Files - Fast I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id11">Memory Mapped Files - Fast I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="#files-ipc">Files - IPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#files-exposing-current-state">Files - Exposing Current State</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spool-folders">Spool Folders</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spool-folders-cron">Spool Folders - Cron</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spool-folders-cups">Spool Folders - CUPS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lock-files">Lock Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#doors">Doors</a></li>
<li class="toctree-l2"><a class="reference internal" href="#server-code">Server Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#client-code">Client Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#domain-sockets">Domain Sockets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#domain-sockets-example">Domain Sockets - Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id12">Domain Sockets - Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id13">Domain Sockets - Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="kernelmm.html">Virtual Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="userlandmm.html">Userland Memory Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="storage.html">Storage and Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="fs.html">Implementing Files and Folders</a></li>
<li class="toctree-l1"><a class="reference internal" href="research.html">Storage Research at Loyola</a></li>
<li class="toctree-l1"><a class="reference internal" href="linux_vm.html">Installing a Linux Virtual Machine with VMware</a></li>
<li class="toctree-l1"><a class="reference internal" href="windows_vm.html">Installing a Windows Virtual Machine with VMware</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Operating Systems</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>IPC Topics</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/ipc.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ipc-topics">
<h1>IPC Topics<a class="headerlink" href="#ipc-topics" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>Pipes</li>
<li>Named Pipes / FIFOs</li>
<li>Signals</li>
<li>Shared memory</li>
<li>Memory mapped files</li>
<li>Locking in shared memory</li>
<li>Files</li>
<li>Domain sockets</li>
<li>Doors</li>
<li>TCP/IP</li>
</ul>
<div class="section" id="ipc-performance-hierarchy">
<h2>IPC Performance Hierarchy<a class="headerlink" href="#ipc-performance-hierarchy" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="first docutils">
<dt>Fastest - no kernel interaction needed, except to setup:</dt>
<dd><ul class="first last">
<li>Shared memory</li>
<li>Locking in shared memory</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Very fast - virtual memory manager involved</dt>
<dd><ul class="first last">
<li>Memory mapped files</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Fast - system calls required - i.e. context switches</dt>
<dd><ul class="first last">
<li>Pipes, FIFOs / Named Pipes</li>
<li>Signals</li>
<li>Domain sockets</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Medium / Slow - FS or network involved</dt>
<dd><ul class="first last">
<li>Files</li>
<li>TCP/UDP sockets</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="pipes">
<h2>Pipes<a class="headerlink" href="#pipes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Pipes are the oldest UNIX IPC mechanism aside from files.</li>
<li>Pipes are half-duplex - data only flows in one direction</li>
<li>Pipes can only be used between processes that have a common
parent. Pipes are created by a parent process and then inherited across a fork() call.</li>
<li>Passing data from one process to another through a pipe involves at least two context switches. A third one is necessary for control to return to the writing process.</li>
<li>Pipes in general are very fast. Sending data at rates of 100s to 1000s of MB/s is possible.</li>
</ul>
</div>
<div class="section" id="id1">
<h2>Pipes<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="first docutils">
<dt>Pipes have two file descriptors</dt>
<dd><ul class="first last">
<li>One file descriptor is read-only</li>
<li>One file descriptor is write-only</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>The Linux call to create a pipe is:</dt>
<dd><ul class="first last">
<li>int pipe(int pipefd[2]);</li>
<li>pipefd[0] is the read-only half</li>
<li>pipefd[1] is the write-only half</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>The Windows call to create a pipe is:</dt>
<dd><ul class="first last">
<li>BOOL CreatePipe(HANDLE readHandle, HANDLE writeHandle, LPSECURITY_ATTRIBUTES attr, DWORD nSize);</li>
<li>readHandle and writeHandle are the read/write file handles</li>
<li>attr allows processes that run under more than one user account to manage security of individual pipes</li>
<li>nSize is the suggested buffer size for the pipe</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="pipes-linux">
<h2>Pipes - Linux<a class="headerlink" href="#pipes-linux" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

        <span class="kt">int</span> <span class="n">pipes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="n">pipe</span><span class="p">(</span><span class="n">pipes</span><span class="p">);</span>

        <span class="kt">int</span> <span class="n">inputPartOfPipe</span> <span class="o">=</span> <span class="n">pipes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">outputPartOfPipe</span> <span class="o">=</span> <span class="n">pipes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>

        <span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">//parent process</span>
                <span class="n">dup2</span><span class="p">(</span><span class="n">inputPartOfPipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// redirect STDIN</span>
                <span class="n">close</span><span class="p">(</span><span class="n">outputPartOfPipe</span><span class="p">);</span>  <span class="c1">// close unused half of pipe</span>
                <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
                <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;child sent value = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">//child process</span>
                <span class="n">dup2</span><span class="p">(</span><span class="n">outputPartOfPipe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// redirect STDOUT</span>
                <span class="n">close</span><span class="p">(</span><span class="n">inputPartOfPipe</span><span class="p">);</span>     <span class="c1">// close unused half of pipe</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;fork failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//don&#39;t worry about closing remaining pipes,</span>
        <span class="c1">//process exit does this for us</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="pipes-context-switches">
<h2>Pipes - Context Switches<a class="headerlink" href="#pipes-context-switches" title="Permalink to this headline">¶</a></h2>
<div class="figure align-center">
<a class="reference internal image-reference" href="_images/pipes-context-switches.png"><img alt="Pipes and Context Switching" src="_images/pipes-context-switches.png" style="width: 600px;" /></a>
</div>
</div>
<div class="section" id="named-pipes-fifos">
<h2>Named Pipes / FIFOs<a class="headerlink" href="#named-pipes-fifos" title="Permalink to this headline">¶</a></h2>
<p>Named pipes are the same as regular pipes except:</p>
<ul class="simple">
<li>Named pipes live in the filesystem namespace</li>
<li>Named pipes can have a different lifespan than individual processes</li>
<li>Since named pipes are files, you can apply more advanced permissions to them</li>
</ul>
</div>
<div class="section" id="example-usage-of-a-regular-pipe-in-linux">
<h2>Example usage of a regular pipe in Linux<a class="headerlink" href="#example-usage-of-a-regular-pipe-in-linux" title="Permalink to this headline">¶</a></h2>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat file | gzip -c9 &gt; file.gz
</pre></div>
</div>
<p>Example usage of a named pipe in Linux:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkfifo pipe_file
$ gzip -c9 &lt; pipe_file &gt; file.gz
$ cat file &gt; pipe_file
$ rm -f pipe_file
</pre></div>
</div>
</div>
<div class="section" id="named-pipes-common-usages">
<h2>Named Pipes - Common Usages<a class="headerlink" href="#named-pipes-common-usages" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Named pipes are commonly used for single machine client / server applications</li>
<li>In Windows, named pipes can ride on top of TCP/IP and be used for intra-machine IPC.</li>
<li><dl class="first docutils">
<dt>To improve performance of applications that are written to only work with files and not with normal pipes.</dt>
<dd><ul class="first last">
<li>Does not work if the program uses random I/O</li>
<li>A program that is written to read a large file from disk can instead read from a named pipe. The named pipe’s data can in turn be produced by another program.</li>
<li>A program that can only work with files from the local disk can be made to work with a file on the web through a named pipe and a command that can write a URL to standard output</li>
<li>This pattern can be used to add encryption, file compression, and other extensions to programs that do not already have them.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="named-pipes-atomic-reads-writes">
<h2>Named Pipes - Atomic Reads / Writes<a class="headerlink" href="#named-pipes-atomic-reads-writes" title="Permalink to this headline">¶</a></h2>
<p>What happens if two processes write to a named pipe at the same time?</p>
<ul class="simple">
<li>If the size of each write(…) call is &lt;= PIPE_BUF, the writes will be atomic and in order.</li>
<li>If the size of each write(…) call is &gt; PIPE_BUF, then the individual writes will be broken up and interleaved with other simultaneous callers.</li>
<li>So, a good rule of thumb, is to make sure that what you write to a named pipe is less than PIPE_BUF in size. Otherwise, you need to guarantee that you are the only one writing to the pipe file</li>
</ul>
</div>
<div class="section" id="signals">
<h2>Signals<a class="headerlink" href="#signals" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Signals are software interrupts / events</li>
<li>Provide a way for handling asynchronous events</li>
<li>Modern UNIX systems have &gt; 30 different signals defined</li>
<li><dl class="first docutils">
<dt>Signals have a concept of disposition or action</dt>
<dd><ul class="first last">
<li>Ignore the signal: works for all signals except SIGKILL, SIGSTOP, and SIGEMT</li>
<li>Catch the signal: program registers with the kernel a function to handle a signal.</li>
<li>Default: allows the signal to perform its default action. Every signal has a default action</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="list-of-important-signals">
<h2>List of Important Signals<a class="headerlink" href="#list-of-important-signals" title="Permalink to this headline">¶</a></h2>
<table border="1" class="colwidths-given docutils" id="id14">
<caption><span class="caption-text">List of Important Signals</span><a class="headerlink" href="#id14" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="19%" />
<col width="81%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Signal</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>SIGABRT</td>
<td>abnormal termination, generated by abort() function. Default terminates and core dumps the process.</td>
</tr>
<tr class="row-odd"><td>SIGALRM</td>
<td>generated when a timer expires. Set by alarm() function.</td>
</tr>
<tr class="row-even"><td>SIGBUS</td>
<td>Indicates a hardware fault. Often memory protection faults. Default terminates the application.</td>
</tr>
<tr class="row-odd"><td>SIGCHLD</td>
<td>Sent to a parent process when a child process terminates.</td>
</tr>
<tr class="row-even"><td>SIGCONT</td>
<td>Sent to a stopped process when it is continued.</td>
</tr>
<tr class="row-odd"><td>SIGEMT</td>
<td>General hardware fault</td>
</tr>
<tr class="row-even"><td>SIGFPE</td>
<td>Arithmetic exception: divide by 0, floating point overflow, etc…</td>
</tr>
<tr class="row-odd"><td>SIGHUP</td>
<td>Terminal is disconnected</td>
</tr>
<tr class="row-even"><td>SIGILL</td>
<td>The process has executed an illegal instruction (like trying to disable interrupts)</td>
</tr>
<tr class="row-odd"><td>SIGINT</td>
<td>Generated by terminal when we press Ctrl-C</td>
</tr>
<tr class="row-even"><td>SIGAIO</td>
<td>Generated when an asynchronous I/O event occurs.</td>
</tr>
<tr class="row-odd"><td>SIGKILL</td>
<td>Can’t be caught or ignored. Default action is to kill a process.</td>
</tr>
<tr class="row-even"><td>SIGPIPE</td>
<td>Generated when you write to a pipe where the reader has been terminated.</td>
</tr>
<tr class="row-odd"><td>SIGSEGV</td>
<td>Segmentation violation</td>
</tr>
<tr class="row-even"><td>SIGSTOP</td>
<td>Sent before a process is put into the stop state.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="handling-signals-example">
<h2>Handling Signals - Example<a class="headerlink" href="#handling-signals-example" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">handler</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argv</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">signal</span><span class="p">(</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
  <span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="n">pause</span><span class="p">();</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">signalNum</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">signalNum</span> <span class="o">==</span> <span class="n">SIGUSR1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;received SIGUSR1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">signalNum</span> <span class="o">==</span> <span class="n">SIGINT</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;received SIGHUP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="sending-signals-example">
<h2>Sending Signals - Example<a class="headerlink" href="#sending-signals-example" title="Permalink to this headline">¶</a></h2>
<p>Signals can be sent to a running process using kill:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ firefox &amp;
[1] 5050
$ kill -USR1 5050        - sends signal SIGUSR to firefox
$ kill 5050              - sends signal SIGTERM to firefox
</pre></div>
</div>
</div>
<div class="section" id="signals-interrupted-system-calls">
<h2>Signals - Interrupted System Calls<a class="headerlink" href="#signals-interrupted-system-calls" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Signals will “wake up” blocking calls to “slow” system calls</li>
<li>In old UNIX, this was any blocking system call.</li>
<li><dl class="first docutils">
<dt>In modern UNIX, the following are “slow” system calls meaning that they can block for ever in theory:</dt>
<dd><ul class="first last">
<li>Reads from pipes, terminal devices, and network devices</li>
<li>Writes to pipes, terminal devices, and network devices if the data cannot be accepted immediately.</li>
<li>Opens of files that block until some condition occurs (such as a serial device or modem connecting).</li>
<li>All calls to the pause() function, pause() waits until signals are caught.</li>
</ul>
</dd>
</dl>
</li>
<li>This means, if you are catching signals, you will have to check errno for EINTR (interrupted by signal) error if these functions return in an error state. If they do, you must retry your operation</li>
<li>In newer UNIX systems, if signals are triggered with a SA_RESTART flag passed to sigaction(…), system calls would be automatically restarted after signal handling completes.</li>
</ul>
</div>
<div class="section" id="signals-reentrant-functions">
<h2>Signals - Reentrant Functions<a class="headerlink" href="#signals-reentrant-functions" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>When handling a signal, the main execution of the process is suspended. The interrupted state is not something that can be examined or otherwise determined.</li>
<li>It is possible that the interrupted state could be inside of a malloc() or free() call. If we call malloc() or free() in the signal handler, we could corrupt the allocated or free list.</li>
<li>So, in signal handlers we can only call reentrant functions.</li>
<li><dl class="first docutils">
<dt>Reentrant functions have the following properties:</dt>
<dd><ul class="first last">
<li>Do not call malloc() or free()</li>
<li>Do not refer to mutable static data structures</li>
<li>Rule of thumb is to call functions that are either system calls or low level wrappers of system calls are safe. Other functions should not be used unless you are certain of their safety.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="id2">
<h2>Signals - Reentrant Functions<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">abort</span>       <span class="n">access</span>       <span class="n">alarm</span>      <span class="n">chdir</span>       <span class="n">chmod</span>        <span class="n">chown</span>
<span class="n">close</span>       <span class="n">creat</span>        <span class="n">dup</span>        <span class="n">dup2</span>        <span class="n">execle</span>       <span class="n">execve</span>
<span class="n">exit</span>        <span class="n">fcntl</span>        <span class="n">fork</span>       <span class="n">fstat</span>       <span class="n">getgid</span>       <span class="n">getuid</span>
<span class="n">kill</span>        <span class="n">link</span>         <span class="n">longjmp</span>    <span class="n">lseek</span>       <span class="n">mkdir</span>        <span class="n">mkfifo</span>
<span class="nb">open</span>        <span class="n">pathconf</span>     <span class="n">pause</span>      <span class="n">pipe</span>        <span class="n">read</span>         <span class="n">rename</span>
<span class="n">rmdir</span>       <span class="n">setgid</span>       <span class="n">setsid</span>     <span class="n">setuid</span>      <span class="n">sigaction</span>    <span class="n">sigaddset</span>
<span class="n">sigdelset</span>   <span class="n">sigemptyset</span>  <span class="n">signal</span>     <span class="n">sigpending</span>  <span class="n">sigsuspend</span>   <span class="n">sleep</span>
<span class="n">stat</span>        <span class="n">sysconf</span>      <span class="n">time</span>       <span class="n">times</span>       <span class="n">umask</span>        <span class="n">uname</span>
<span class="n">unlink</span>      <span class="n">utime</span>        <span class="n">wait</span>       <span class="n">waitpid</span>     <span class="n">write</span>
</pre></div>
</div>
</div>
<div class="section" id="signals-sending-in-code">
<h2>Signals - Sending In Code<a class="headerlink" href="#signals-sending-in-code" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="first docutils">
<dt>Sending a signal to another process:</dt>
<dd><ul class="first last">
<li>int kill(pid_t pid, int signo);</li>
<li>pid &gt; 0, signal is sent to process with id = pid</li>
<li>pid = 0, signal sent to all process whose group ID is the same as the sender of the signal. Will not send to init or swapper daemons.</li>
<li>pid &lt; 0, signal is sent to all processes whose process group ID equals the absolute value of pid for which the sender has permission to send the signal.</li>
<li>pid = -1, undefined.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Sending a signal to your own process:</dt>
<dd><ul class="first last">
<li>int raise(int signo);</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Sending SIGALRM (terminates process by default):</dt>
<dd><ul class="first last">
<li>int alarm(unsigned int seconds);</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Waiting for signals:</dt>
<dd><ul class="first last">
<li>int pause(void);</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="example-implementing-sleep-with-alarm">
<h2>Example - implementing sleep() with alarm<a class="headerlink" href="#example-implementing-sleep-with-alarm" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="kt">void</span> <span class="nf">sig_alrm</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">)</span> 
    <span class="p">{</span>
       <span class="cm">/* ... */</span>
    <span class="p">}</span>

    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sleepFor</span><span class="p">(</span><span class="kt">int</span> <span class="n">numSeconds</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">signal</span><span class="p">(</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">sig_alrm</span><span class="p">);</span>    <span class="c1">//set signal handler</span>
       <span class="n">alarm</span><span class="p">(</span><span class="n">numSeconds</span><span class="p">);</span>            <span class="c1">//set alarm for n-seconds</span>
       <span class="n">pause</span><span class="p">();</span>                      <span class="c1">//wait for signal</span>
       <span class="k">return</span> <span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>              <span class="c1">//turn off alarm</span>
       <span class="n">handler</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="example-better-sleep-implementation">
<h2>Example - “better” sleep implementation<a class="headerlink" href="#example-better-sleep-implementation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">jmpbuf</span> <span class="n">env_alrm</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">sig_alrm</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">longjmp</span><span class="p">(</span><span class="n">env_alrm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">unsinged</span> <span class="kt">int</span> <span class="nf">sleepFor</span><span class="p">(</span><span class="kt">int</span> <span class="n">numSeconds</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">sig_alrm</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">env_alrm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">alarm</span><span class="p">(</span><span class="n">nsecs</span><span class="p">);</span>
        <span class="n">pause</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="demonstrating-the-sleepfor-problem">
<h2>Demonstrating the sleepFor problem<a class="headerlink" href="#demonstrating-the-sleepfor-problem" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">sig_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">volatile</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sig_int enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sig_int done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">sig_int</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unslept</span> <span class="o">=</span> <span class="n">sleepFor</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;sleepFor returned: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unslept</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="history-of-sleep-and-why-signals-are-scary">
<h2>History of sleep and why signals are scary.<a class="headerlink" href="#history-of-sleep-and-why-signals-are-scary" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>These two sleep implementations are similar to historical implementations of the sleep() call in UNIX</li>
<li>Both of these demonstrate that implementations of signal handlers need to be handled with great care.</li>
<li>You must remember the following between signal and pause: Between the signal registration and the pause call, you may receive the signal. Pause could block forever because of this</li>
<li><dl class="first docutils">
<dt>You must remember the following in signal handlers:</dt>
<dd><ul class="first last">
<li>You may be interrupting execution of the main program or another signal handler.</li>
<li>Avoid modifying global variables</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Avoid non-reentrant functions</dt>
<dd><ul class="first last">
<li>Be careful of stack modifying functions like setjmp or longjmp</li>
<li>If you need this behavior, look towards sigsetjmp or siglongjmp</li>
<li>Be careful of what signals your handler generates</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="other-uses-for-alarm">
<h2>Other uses for alarm(…)<a class="headerlink" href="#other-uses-for-alarm" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Aside from using alarm() to implement a sleep() call</li>
<li>alarm() can be used to put an upper time limit on slow or blocking operations.</li>
<li>If we want to ensure that we don’t wait on a call to read from a named pipe forever, we can setup an alarm call.</li>
</ul>
</div>
<div class="section" id="memory-mapped-files">
<h2>Memory Mapped Files<a class="headerlink" href="#memory-mapped-files" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Memory mapped files are one of two ways to share memory regions between applications.</li>
<li><dl class="first docutils">
<dt>First, there are some virtual memory concepts that we need to introduce:</dt>
<dd><ul class="first last">
<li>Virtual address - the address that the program sees for an object in memory</li>
<li>Physical address - the real address (if it exists) of an object in physical memory</li>
<li>Physical and virtual addresses are almost never the same.</li>
<li>Backing store - the non physical memory location that backs a physical memory object.</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>All</strong> physical memory objects have backing stores</dt>
<dd><ul class="first last">
<li>text segments - executable and library files</li>
<li>data, stack segments - swap files</li>
<li>memory mapped regions - memory mapped files</li>
</ul>
</dd>
</dl>
</li>
<li>We will dig deeper into virtual memory in a later lecture, but these concepts will be sufficient to proceed</li>
</ul>
</div>
<div class="section" id="id3">
<h2>Memory Mapped Files<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The technique used in memory mapped files is simple but very powerful.</li>
<li>Fundamentally, when you memory map a file with the mmap() function, you are declaring a region of virtual memory to be backed by a file.</li>
<li>This means, when you write to this mapped region, the values will appear (to other programs) immediately in the backing file. If the backing file is updated, the values in that file will (to the running program) appear immediately in memory.</li>
<li>When two programs map a file into virtual memory, the virtual addresses will most likely differ between the programs.</li>
<li>Two programs that have the same region of a memory mapped file mapped to memory will be able to communicate with each other by reading and writing values to that memory region</li>
</ul>
</div>
<div class="section" id="id4">
<h2>Memory Mapped Files<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="memory-mapped-files-virtual-addresses">
<h2>Memory Mapped Files - Virtual Addresses<a class="headerlink" href="#memory-mapped-files-virtual-addresses" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>There are two instances in virtual memory where position independent code (the use of relative memory addressing) must be used.</li>
<li>Shared libraries - because the data / bss segments are shared among processes and mapped to different virtual addresses.</li>
<li>Memory mapped files - because the memory mapped file is mapped to different virtual addresses in different processes.</li>
<li>To implement position independent code, techniques similar to -fpic used in GCC must be used by code that you write to work with memory mapped regions.</li>
<li><dl class="first docutils">
<dt>Rules for writing position independent code in memory mapped regions:</dt>
<dd><ul class="first last">
<li>Do not pass pointers or structures that make use of pointers. Pointers use virtual addresses.</li>
<li>Objects in memory mapped regions should not refer to objects outside of memory mapped regions.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="absolute-memory-addressing">
<h2>Absolute Memory Addressing<a class="headerlink" href="#absolute-memory-addressing" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">char</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="n">Brand</span><span class="p">;</span>
    <span class="kt">char</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">TractionRating</span><span class="p">;</span>
    <span class="kt">char</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">SpeedRating</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Wheel</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Wheel</span><span class="o">*</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">Wheels</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">Make</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">Model</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Car</span><span class="p">;</span>

<span class="n">Car</span><span class="o">*</span> <span class="n">car</span> <span class="o">=</span> <span class="p">(</span><span class="n">Car</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Car</span><span class="p">));</span>
<span class="n">car</span><span class="p">.</span><span class="n">Make</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="mi">50</span><span class="p">);</span>
<span class="n">car</span><span class="p">.</span><span class="n">Model</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="mi">50</span><span class="p">);</span>
<span class="n">car</span><span class="p">.</span><span class="n">Wheels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Wheel</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Wheel</span><span class="p">));</span>
<span class="n">car</span><span class="p">.</span><span class="n">Wheels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Wheel</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Wheel</span><span class="p">));</span>
<span class="n">car</span><span class="p">.</span><span class="n">Wheels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Wheel</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Wheel</span><span class="p">));</span>
<span class="n">car</span><span class="p">.</span><span class="n">Wheels</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Wheel</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Wheel</span><span class="p">));</span>

<span class="n">car</span><span class="p">.</span><span class="n">Wheels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Brand</span>
</pre></div>
</td></tr></table></div>
<p>Here, the location of each of the wheel objects is stored with an absolute reference from the Car. If this is shared in a memory mapped file, a call to car.Wheels[0] will not resolve to a correct address.</p>
</div>
<div class="section" id="relative-memory-addressing">
<h2>Relative Memory Addressing<a class="headerlink" href="#relative-memory-addressing" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">char</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="n">Brand</span><span class="p">;</span>
    <span class="kt">char</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">TractionRating</span><span class="p">;</span>
    <span class="kt">char</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">SpeedRating</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Wheel</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Wheel</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">Wheels</span><span class="p">;</span>
    <span class="kt">char</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="n">Make</span><span class="p">;</span>
    <span class="kt">char</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="n">Model</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Car</span><span class="p">;</span>

<span class="n">Car</span><span class="o">*</span> <span class="n">car</span> <span class="o">=</span> <span class="p">(</span><span class="n">Car</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Car</span><span class="p">));</span>
</pre></div>
</td></tr></table></div>
<p>Here, we are using relative addressing. The entire Car struct is allocated in a contiguous memory region. To access each wheel, you need only use an offset from the beginning of the Car struct.</p>
</div>
<div class="section" id="linux-minix-use-of-mmap">
<h2>Linux / Minix - Use of mmap()<a class="headerlink" href="#linux-minix-use-of-mmap" title="Permalink to this headline">¶</a></h2>
<p>General Algorithm:</p>
<ol class="arabic simple">
<li>Process A creates file on disk</li>
<li>Process A seeks a length of N</li>
<li>Process A writes a 0 to the file</li>
<li>Process A calls mmap on the file to map it to memory</li>
<li>Process A copies its data structures into the mapped region</li>
<li>Process B calls mmap on the file to map it to memory</li>
<li>Process A and B proceed using the mapped region to cooperate</li>
</ol>
</div>
<div class="section" id="mmap-simple-example">
<h2>mmap - simple example<a class="headerlink" href="#mmap-simple-example" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="s">&quot;Hello World&quot;</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">dummyValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">dataSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">strlen</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;shared.dat&quot;</span><span class="p">,</span> <span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_TRUNC</span><span class="o">|</span><span class="n">O_RDWR</span><span class="p">,</span> <span class="mo">0666</span><span class="p">);</span>
    <span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dummyValue</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
    
    <span class="kt">void</span><span class="o">*</span> <span class="n">map</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">dataSize</span><span class="p">,</span><span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="n">MAP_SHARED</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">);</span>

    <span class="n">getchar</span><span class="p">();</span>

    <span class="n">munmap</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id5">
<h2>mmap - simple example<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">stat</span> <span class="n">fileStat</span><span class="p">;</span>
    <span class="n">stat</span><span class="p">(</span><span class="s">&quot;shared.dat&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fileStat</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">fileSize</span> <span class="o">=</span> <span class="n">fileStat</span><span class="p">.</span><span class="n">st_size</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;shared.dat&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>

    <span class="kt">void</span><span class="o">*</span> <span class="n">map</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">fileSize</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="kt">char</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">fileSize</span><span class="p">);</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">map</span><span class="p">,</span> <span class="n">fileSize</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

    <span class="n">free</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">munmap</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="memory-mapped-files-atomicity">
<h2>Memory Mapped Files - Atomicity<a class="headerlink" href="#memory-mapped-files-atomicity" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>When we explored pipes, we learned that writing to a pipe (below a certain limit) is an atomic operation. We get this guarantee because the OS kernel guarantees this by guaranteeing that system calls are atomic.</li>
<li>The only system calls involved in memory mapped files are mmap and munmap. These are only for initializing and cleaning up mapped memory regions.</li>
<li>Reading and writing mapped memory regions does not involve system calls and carries no guarantee of atomicity. It is similar to multiple threads writing to the same heap.</li>
<li><dl class="first docutils">
<dt>To achieve atomicity in memory mapped regions, you must use:</dt>
<dd><ul class="first last">
<li>Mutexes</li>
<li>Semaphores</li>
<li>Monitors / Condition Variables</li>
</ul>
</dd>
</dl>
</li>
<li>The implementation that you use must also use relative addressing internally or otherwise be able to be configured for it.</li>
<li>The fact that memory mapped regions do not guarantee atomicity and do not use context switches is also why memory mapped regions perform so well.</li>
<li>In general, the fewer the guarantees a mechanism provides, the faster it is.</li>
</ul>
</div>
<div class="section" id="memory-mapped-files-bounded-buffer">
<h2>Memory Mapped Files - Bounded Buffer<a class="headerlink" href="#memory-mapped-files-bounded-buffer" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;semaphore.h&gt;</span><span class="cp"></span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">MessageQueueSize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">MaxMessageSize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">);</span>

<span class="n">class</span> <span class="n">Message</span> <span class="p">{</span>
<span class="nl">public</span><span class="p">:</span>
  <span class="o">~</span><span class="n">Message</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">EnqueueMessage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
  <span class="kt">char</span><span class="o">*</span> <span class="nf">DequeueMessage</span><span class="p">();</span>
  <span class="k">static</span> <span class="n">Message</span> <span class="o">*</span><span class="nf">CopyToMemoryMappedFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>
  <span class="k">static</span> <span class="n">Message</span> <span class="o">*</span><span class="nf">GetFromMemoryMappedFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ReleaseFile</span><span class="p">(</span><span class="n">Message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">);</span>
<span class="nl">private</span><span class="p">:</span>
  <span class="n">Message</span><span class="p">();</span>
  <span class="n">sem_t</span> <span class="n">_lock</span><span class="p">;</span>
  <span class="n">sem_t</span> <span class="n">_empty</span><span class="p">;</span>
  <span class="n">sem_t</span> <span class="n">_full</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">_current</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">_messages</span><span class="p">[</span><span class="n">MessageQueueSize</span><span class="p">][</span><span class="n">MaxMessageSize</span><span class="p">];</span>
<span class="p">};</span>

</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id6">
<h2>Memory Mapped Files - Bounded Buffer<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">Message</span><span class="o">::</span><span class="n">Message</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_lock</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>                                <span class="c1">//passing 1 as the 2nd parameter allows the</span>
  <span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_empty</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>                              <span class="c1">//semaphore work in a memory mapped region</span>
  <span class="n">sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_full</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">MessageQueueSize</span><span class="p">);</span>
  <span class="n">_current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">Message</span><span class="o">::~</span><span class="n">Message</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
<span class="n">Message</span> <span class="o">*</span><span class="n">Message</span><span class="o">::</span><span class="n">CopyToMemoryMappedFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">datasize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Message</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;message size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">datasize</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Message</span><span class="p">),</span> <span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error in lseek</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">dummyVal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dummyVal</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error in write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Message</span><span class="p">),</span> <span class="p">(</span><span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">),</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;mmap() returned -1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Message</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Message</span><span class="p">();</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Message</span><span class="p">));</span>
  <span class="n">delete</span> <span class="n">msg</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">Message</span><span class="o">*</span><span class="p">)</span><span class="n">map</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id7">
<h2>Memory Mapped Files - Bounded Buffer<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">Message</span> <span class="o">*</span><span class="n">Message</span><span class="o">::</span><span class="n">GetFromMemoryMappedFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span>
     <span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Message</span><span class="p">),</span> 
     <span class="p">(</span><span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">),</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;mmap() returned -1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Message</span><span class="o">*</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">Message</span><span class="o">*</span><span class="p">)</span><span class="n">map</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Message</span><span class="o">::</span><span class="n">ReleaseFile</span><span class="p">(</span><span class="n">Message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">munmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Message</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;munmap() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
</div>
<hr class="docutils" />
<div class="section" id="id8">
<h2>Memory Mapped Files - Bounded Buffer<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">Message</span><span class="o">::</span><span class="n">EnqueueMessage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_full</span><span class="p">);</span>
  <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_lock</span><span class="p">);</span>
  <span class="n">_current</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_messages</span><span class="p">[</span><span class="n">_current</span><span class="p">],</span> <span class="n">MaxMessageSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_messages</span><span class="p">[</span><span class="n">_current</span><span class="p">],</span> <span class="n">msg</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
  <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_lock</span><span class="p">);</span>
  <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_empty</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">char</span><span class="o">*</span> <span class="n">Message</span><span class="o">::</span><span class="n">DequeueMessage</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">MaxMessageSize</span><span class="p">];</span>
  <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_empty</span><span class="p">);</span>
  <span class="n">sem_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_lock</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_messages</span><span class="p">[</span><span class="n">_current</span><span class="p">],</span> <span class="n">MaxMessageSize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
  <span class="n">_current</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_lock</span><span class="p">);</span>
  <span class="n">sem_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_full</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id9">
<h2>Memory Mapped Files - Bounded Buffer<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<p>Producer Code</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sharedFileName</span> <span class="o">=</span> <span class="s">&quot;shared.dat&quot;</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">mode_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="mo">0666</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">openFlags</span> <span class="o">=</span> <span class="p">(</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_TRUNC</span> <span class="o">|</span> <span class="n">O_RDWR</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">sharedFileName</span><span class="p">,</span> <span class="n">openFlags</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">&quot;open returned (-1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
     <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">Message</span><span class="o">*</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="o">::</span><span class="n">CopyToMemoryMappedFile</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
     <span class="kt">char</span> <span class="n">message</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
     <span class="n">sprintf</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
     <span class="n">msg</span><span class="o">-&gt;</span><span class="n">EnqueueMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">&quot;enqueued %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;message queue written</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">getchar</span><span class="p">();</span>
  <span class="n">Message</span><span class="o">::</span><span class="n">ReleaseFile</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id10">
<h2>Memory Mapped Files - Bounded Buffer<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h2>
<p>Consumer Code</p>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sharedFileName</span> <span class="o">=</span> <span class="s">&quot;shared.dat&quot;</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">mode_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="mo">0666</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">openFlags</span> <span class="o">=</span> <span class="p">(</span><span class="n">O_RDWR</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">sharedFileName</span><span class="p">,</span> <span class="n">openFlags</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">&quot;open returned (-1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
     <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">Message</span><span class="o">*</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="o">::</span><span class="n">GetFromMemoryMappedFile</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

  <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
     <span class="kt">char</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">DequeueMessage</span><span class="p">();</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d: %s&quot;</span><span class="p">,</span> <span class="o">++</span><span class="n">count</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
     <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">Message</span><span class="o">::</span><span class="n">ReleaseFile</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>

  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="memory-mapped-files-fast-i-o">
<h2>Memory Mapped Files - Fast I/O<a class="headerlink" href="#memory-mapped-files-fast-i-o" title="Permalink to this headline">¶</a></h2>
<p>Memory mapped I/O is faster because it avoids a copy from user mode to kernel mode</p>
<p>Normal User - Kernel write(…) call algorithm:</p>
<ol class="arabic simple">
<li>user app - write(fd, user_buf, len);</li>
<li>user app - context switch into OS (software interrupt)</li>
<li>kernel mode - allocate space in file, check security, etc…</li>
<li>kernel mode - copy user_buf to FS buffer cache</li>
<li>kernel mode - context switch into user app (interrupt return)</li>
<li>at some later time, kernel commits buffer cache to disk</li>
</ol>
<p>Normal User - Kernel mmap(…) write algorithm:</p>
<ol class="arabic simple">
<li>user app - copy values to mapped region</li>
<li>kernel mode - MMU triggers page fault (hardware interrupt)</li>
<li>kernel mode - writes page to backing store</li>
<li>kernel mode - context switch to user app (interrupt return)</li>
</ol>
</div>
<div class="section" id="id11">
<h2>Memory Mapped Files - Fast I/O<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The read algorithm for regular read vs. mmap read is very similar to the write algorithm and also avoids a kernel to user mode copy</li>
<li>On systems with large address spaces (64-bit), memory mapped I/O can be very advantageous. - For example, a database server can memory map an entire database that is several TB in size into memory.</li>
<li>Since most VM systems user a very efficient LRU algorithm and have a lot of I/O scheduling data, memory mapping large files is amongst the fastest approaches.</li>
<li>Other advanced approaches include scatter/gather or vectored I/O.</li>
<li>Memory mapped I/O carries the greatest advantage when the structure of the file maps well into the domain model. This means that no serialization / deserialization is needed.</li>
</ul>
</div>
<div class="section" id="files-ipc">
<h2>Files - IPC<a class="headerlink" href="#files-ipc" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Files are the oldest and most generally used form of IPC</li>
<li>Almost every resource in a modern operating system is accessible through a file based contract (open, read, write, seek, close)</li>
<li>File based IPC is available in almost every operating system.</li>
<li><dl class="first docutils">
<dt>File based IPC, in modern times is best considered in a few patterns:</dt>
<dd><ul class="first last">
<li>State persistence - beyond the lifetime of a program</li>
<li>Exposing current state - during program execution</li>
<li>Queues / Spooling folders - mail daemons, printers, execution queues</li>
<li>Resource state expression - lock files, availability, etc…</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="files-exposing-current-state">
<h2>Files - Exposing Current State<a class="headerlink" href="#files-exposing-current-state" title="Permalink to this headline">¶</a></h2>
<p>/proc filesystems are important ways for OS designers to expose system
information without inventing new system calls.</p>
<ul class="simple">
<li>This is a key advantage for kernel module developers and for device driver developers</li>
<li>Also provides a great way to debug kernel changes</li>
</ul>
<table border="1" class="colwidths-given docutils" id="id15">
<caption><span class="caption-text">List of /proc-style Filesystems</span><a class="headerlink" href="#id15" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Filesystem</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Filesystem</td>
<td>Description</td>
</tr>
<tr class="row-odd"><td>/proc/vmstat</td>
<td>virtual memory stats and configuration</td>
</tr>
<tr class="row-even"><td>/proc/cpuinfo</td>
<td>individual CPU information</td>
</tr>
<tr class="row-odd"><td>/proc/&lt;PID&gt;</td>
<td>individual process information</td>
</tr>
<tr class="row-even"><td>/proc/loadavg</td>
<td>moving average of ready process load</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="spool-folders">
<h2>Spool Folders<a class="headerlink" href="#spool-folders" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="first docutils">
<dt>Spool folders are most commonly used for:</dt>
<dd><ul class="first last">
<li>E-mail daemons (Postfix, Exchange, etc…)</li>
<li>Printer managers (CUPS, lpr, etc…)</li>
<li>Job managers (CRON, etc…)</li>
</ul>
</dd>
</dl>
</li>
<li>Spool folders are folders reserved for a single process that’s single task is to monitor the folder and process each new file created in the folder. Each file in the folder represents a task to complete.</li>
<li>Spool folders, like other persisted queueing systems are resilient to failure. If the processing daemon crashes, it can be restarted without losing the task list.</li>
<li>Often, spool folders are processed by some defined order. One typical order is to process files alphabetically.</li>
<li>If the jobs are not meant to be repeated, files are typically moved to another folder upon completion or deleted.</li>
</ul>
</div>
<div class="section" id="spool-folders-cron">
<h2>Spool Folders - Cron<a class="headerlink" href="#spool-folders-cron" title="Permalink to this headline">¶</a></h2>
<p>Cron typically maintains a few spool folders under /etc:</p>
<ul class="simple">
<li>/etc/cron.daily</li>
<li>/etc/cron.hourly</li>
<li>/etc/cron.monthly</li>
<li>/etc/cron.weekly</li>
</ul>
<p>Cron will, at the correct time, enter each of these folders and execute every executable file in each of these folders.</p>
</div>
<div class="section" id="spool-folders-cups">
<h2>Spool Folders - CUPS<a class="headerlink" href="#spool-folders-cups" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>CUPS is a printer daemon for UNIX operating systems</li>
<li>The spool folder for CUPS is typically /var/spool/cups</li>
<li><dl class="first docutils">
<dt>In the spool folder there are two types of files:</dt>
<dd><ul class="first last">
<li><dl class="first docutils">
<dt>Data files - The object that is being printed</dt>
<dd><ul class="first last">
<li>Named d00001-001, d00001-002, d00002-001,….</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Control files - A file that represents a set of data files</dt>
<dd><ul class="first last">
<li>Named c00001, c00002, ….</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li>The use of this file naming convention exposes a domain model of sorts that the CUPS system respects in its queue.</li>
<li>CUPS has a series of programs that manage the creation of files in the spooling folder and the processing of files once in the spooling folder.</li>
</ul>
</div>
<div class="section" id="lock-files">
<h2>Lock Files<a class="headerlink" href="#lock-files" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>A useful aspect of all system calls is that they are atomic operations. This means that some system calls can be used to perform test-and-set like operations and be the basis of locking systems.</li>
<li><dl class="first docutils">
<dt>A common example is the use of files to make sure only one instance of a software program is running at one time.</dt>
<dd><ul class="first last">
<li>For example, you would not want to HTTP daemons running on the same port.</li>
<li>To prevent this, you could create a lock file like /var/lock/http_80.</li>
<li>When the HTTP daemon starts up, it can check very early on for a /var/lock/http_## for the port it is configured on before proceeding. When the daemon shuts down it can delete the file</li>
</ul>
</dd>
</dl>
</li>
<li>The creation of and deletion of files is an atomic operation. So, if two processes both try at the same time to create the same file, only one will succeed.</li>
</ul>
</div>
<div class="section" id="doors">
<h2>Doors<a class="headerlink" href="#doors" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Doors pretty much only exist on Solaris and nowhere else</li>
<li>Even so, they are an interesting concept.</li>
<li>Doors basically allow a process to expose one or more functions through one or more files on the filesystem. It is basically a file system based RPC mechanism</li>
</ul>
</div>
<div class="section" id="server-code">
<h2>Server Code<a class="headerlink" href="#server-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">server</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">cookie</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">arg_size</span><span class="p">,</span> <span class="n">door_desc_t</span><span class="o">*</span> <span class="n">dp</span><span class="p">,</span> <span class="n">uint_t</span> <span class="n">n_desc</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/*server code goes here*/</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="n">doorfd</span> <span class="o">=</span> <span class="n">door_create</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">creat</span><span class="p">(</span><span class="s">&quot;/tmp/door&quot;</span><span class="p">,</span> <span class="mo">0666</span><span class="p">);</span>
<span class="n">fdetach</span><span class="p">(</span><span class="s">&quot;/tmp/door&quot;</span><span class="p">);</span>
<span class="n">fattach</span><span class="p">(</span><span class="n">doorfd</span><span class="p">,</span><span class="s">&quot;/tmp/door&quot;</span><span class="p">);</span>
<span class="n">pause</span><span class="p">();</span>

</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="client-code">
<h2>Client Code<a class="headerlink" href="#client-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">typdef</span> <span class="k">struct</span> <span class="n">myArg</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">id</span>
<span class="p">}</span> <span class="n">myArg_t</span><span class="p">;</span>

<span class="n">door_arg_t</span> <span class="n">d_arg</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">doorfd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/tmp/door&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<span class="n">myArg_t</span><span class="o">*</span> <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">myArg_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">myArg_t</span><span class="p">));</span>
<span class="n">arg</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
<span class="n">d_arg</span><span class="p">.</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
<span class="n">d_arg</span><span class="p">.</span><span class="n">data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="n">d_arg</span><span class="p">.</span><span class="n">desc_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">d_arg</span><span class="p">.</span><span class="n">desc_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">door_call</span><span class="p">(</span><span class="n">doorfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d_arg</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="domain-sockets">
<h2>Domain Sockets<a class="headerlink" href="#domain-sockets" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><dl class="first docutils">
<dt>Domain sockets serve the same purpose as named pipes, except that domain sockets are:</dt>
<dd><ul class="first last">
<li>Full - duplex</li>
<li>Can have many clients to one server</li>
<li>Support datagram and streaming modes</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Domain sockets use functions that are very similar to what is used with internet sockets:</dt>
<dd><ul class="first last">
<li>accept, bind, listen, connect, socket</li>
</ul>
</dd>
</dl>
</li>
<li>The setup for domain sockets can be a bit complex, so the best way to explain is through a simple example.</li>
</ul>
</div>
<div class="section" id="domain-sockets-example">
<h2>Domain Sockets - Example<a class="headerlink" href="#domain-sockets-example" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">server_listen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">unlink</span><span class="p">(</span><span class="n">fileName</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">socket_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">address</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span><span class="p">));</span>
  <span class="n">address</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">fileName</span><span class="p">);</span>

  <span class="n">bind</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span><span class="p">));</span>
  <span class="n">listen</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">connection_fd</span><span class="p">;</span>
  <span class="kt">socklen_t</span> <span class="n">address_length</span><span class="p">;</span>
  <span class="k">while</span><span class="p">((</span><span class="n">connection_fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_length</span><span class="p">))</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
     <span class="kt">int</span> <span class="n">child</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
     <span class="k">if</span><span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">connection_handler</span><span class="p">(</span><span class="n">connection_fd</span><span class="p">);</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">connection_fd</span><span class="p">);</span>
     <span class="p">}</span> 
  <span class="p">}</span>

  <span class="n">close</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>
  <span class="n">unlink</span><span class="p">(</span><span class="n">fileName</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id12">
<h2>Domain Sockets - Example<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">connection_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket_fd</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">nBytes</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
  <span class="n">buff</span><span class="p">[</span><span class="n">nBytes</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;message from client: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buff</span><span class="p">);</span>
  <span class="n">nBytes</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="s">&quot;hello from server&quot;</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">nBytes</span><span class="p">);</span>

  <span class="n">close</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id13">
<h2>Domain Sockets - Example<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">client_connect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fileName</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">socket_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">address</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span><span class="p">));</span>
  <span class="n">address</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
  <span class="n">sprintf</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">fileName</span><span class="p">);</span>

  <span class="n">connect</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span><span class="p">));</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">nBytes</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="s">&quot;hello from a client&quot;</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">nBytes</span><span class="p">);</span>

  <span class="n">nBytes</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
  <span class="n">buffer</span><span class="p">[</span><span class="n">nBytes</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;message from server: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

  <span class="n">close</span><span class="p">(</span><span class="n">socket_fd</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="kernelmm.html" class="btn btn-neutral float-right" title="Virtual Memory" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="deadlock.html" class="btn btn-neutral float-left" title="Deadlock" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013-2020, Operating Systems Faculty at Loyola University Chicago

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>