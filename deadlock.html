<!DOCTYPE html>

<html :class="{'dark': darkMode === 'dark' || (darkMode === 'system' &amp;&amp; window.matchMedia('(prefers-color-scheme: dark)').matches)}" class="scroll-smooth" data-content_root="./" lang="en" x-data="{ darkMode: localStorage.getItem('darkMode') || localStorage.setItem('darkMode', 'system'), activeSection: '' }" x-init="$watch('darkMode', val =&gt; localStorage.setItem('darkMode', val))">
<head>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta charset="utf-8"/>
<meta content="white" media="(prefers-color-scheme: light)" name="theme-color"/>
<meta content="black" metia="(prefers-color-scheme: dark)" name="theme-color"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Deadlock | Operating Systems: updated 28 Dec 2023</title>
<meta content="Deadlock | Operating Systems: updated 28 Dec 2023" property="og:title"/>
<meta content="Deadlock | Operating Systems: updated 28 Dec 2023" name="twitter:title"/>
<link href="_static/pygments.css?v=fa44fd50" rel="stylesheet" type="text/css"/>
<link href="_static/theme.css?v=7112734b" rel="stylesheet" type="text/css"/>
<link href="search.html" rel="search" title="Search"/>
<link href="genindex.html" rel="index" title="Index"/>
<link href="ipc.html" rel="next" title="IPC Topics"/>
<link href="mutualexclusion.html" rel="prev" title="Mutual Exclusion"/>
<script>
    <!-- Prevent Flash of wrong theme -->
      const userPreference = localStorage.getItem('darkMode');
      let mode;
      if (userPreference === 'dark' || window.matchMedia('(prefers-color-scheme: dark)').matches) {
        mode = 'dark';
        document.documentElement.classList.add('dark');
      } else {
        mode = 'light';
      }
      if (!userPreference) {localStorage.setItem('darkMode', mode)}
    </script>
</head>
<body :class="{ 'overflow-hidden': showSidebar }" class="min-h-screen font-sans antialiased bg-background text-foreground" x-data="{ showSidebar: false }">
<div @click.self="showSidebar = false" class="fixed inset-0 z-50 overflow-hidden bg-background/80 backdrop-blur-sm" x-cloak="" x-show="showSidebar"></div><div class="relative flex flex-col min-h-screen" id="page"><a class="absolute top-0 left-0 z-[100] block bg-background p-4 text-xl transition -translate-x-full opacity-0 focus:translate-x-0 focus:opacity-100" href="#content">
      Skip to content
    </a><header class="sticky top-0 z-40 w-full border-b shadow-sm border-border supports-backdrop-blur:bg-background/60 bg-background/95 backdrop-blur"><div class="container flex items-center h-14">
<div class="hidden mr-4 md:flex">
<a class="flex items-center mr-6" href="index.html"><span class="hidden font-bold sm:inline-block text-clip whitespace-nowrap">Operating Systems: updated 28 Dec 2023</span>
</a></div><button @click="showSidebar = true" class="inline-flex items-center justify-center h-10 px-0 py-2 mr-2 text-base font-medium transition-colors rounded-md hover:text-accent-foreground hover:bg-transparent md:hidden" type="button">
<svg aria-hidden="true" fill="currentColor" height="24" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M152.587 825.087q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440Zm0-203.587q-19.152 0-32.326-13.174T107.087 576q0-19.152 13.174-32.326t32.326-13.174h320q19.152 0 32.326 13.174T518.087 576q0 19.152-13.174 32.326T472.587 621.5h-320Zm0-203.587q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440ZM708.913 576l112.174 112.174q12.674 12.674 12.674 31.826t-12.674 31.826Q808.413 764.5 789.261 764.5t-31.826-12.674l-144-144Q600 594.391 600 576t13.435-31.826l144-144q12.674-12.674 31.826-12.674t31.826 12.674q12.674 12.674 12.674 31.826t-12.674 31.826L708.913 576Z"></path>
</svg>
<span class="sr-only">Toggle navigation menu</span>
</button>
<div class="flex items-center justify-between flex-1 space-x-2 sm:space-x-4 md:justify-end">
<div class="flex-1 w-full md:w-auto md:flex-none"><form @keydown.k.window.meta="$refs.search.focus()" action="search.html" class="relative flex items-center group" id="searchbox" method="get">
<input aria-label="Search the docs" class="inline-flex items-center font-medium transition-colors bg-transparent focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ring-offset-background border border-input hover:bg-accent focus:bg-accent hover:text-accent-foreground focus:text-accent-foreground hover:placeholder-accent-foreground py-2 px-4 relative h-9 w-full justify-start rounded-[0.5rem] text-sm text-muted-foreground sm:pr-12 md:w-40 lg:w-64" id="search-input" name="q" placeholder="Search ..." type="search" x-ref="search"/>
<kbd class="pointer-events-none absolute right-1.5 top-2 hidden h-5 select-none text-muted-foreground items-center gap-1 rounded border border-border bg-muted px-1.5 font-mono text-[10px] font-medium opacity-100 sm:flex group-hover:bg-accent group-hover:text-accent-foreground">
<span class="text-xs">⌘</span>
    K
  </kbd>
</form>
</div>
<nav class="flex items-center space-x-1">
<button @click="darkMode = darkMode === 'light' ? 'dark' : 'light'" class="relative inline-flex items-center justify-center px-0 text-sm font-medium transition-colors rounded-md hover:bg-accent hover:text-accent-foreground h-9 w-9" type="button">
<svg class="absolute transition-all scale-100 rotate-0 dark:-rotate-90 dark:scale-0" fill="currentColor" height="24" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M480 685q45.456 0 77.228-31.772Q589 621.456 589 576q0-45.456-31.772-77.228Q525.456 467 480 467q-45.456 0-77.228 31.772Q371 530.544 371 576q0 45.456 31.772 77.228Q434.544 685 480 685Zm0 91q-83 0-141.5-58.5T280 576q0-83 58.5-141.5T480 376q83 0 141.5 58.5T680 576q0 83-58.5 141.5T480 776ZM80 621.5q-19.152 0-32.326-13.174T34.5 576q0-19.152 13.174-32.326T80 530.5h80q19.152 0 32.326 13.174T205.5 576q0 19.152-13.174 32.326T160 621.5H80Zm720 0q-19.152 0-32.326-13.174T754.5 576q0-19.152 13.174-32.326T800 530.5h80q19.152 0 32.326 13.174T925.5 576q0 19.152-13.174 32.326T880 621.5h-80Zm-320-320q-19.152 0-32.326-13.174T434.5 256v-80q0-19.152 13.174-32.326T480 130.5q19.152 0 32.326 13.174T525.5 176v80q0 19.152-13.174 32.326T480 301.5Zm0 720q-19.152 0-32.326-13.17Q434.5 995.152 434.5 976v-80q0-19.152 13.174-32.326T480 850.5q19.152 0 32.326 13.174T525.5 896v80q0 19.152-13.174 32.33-13.174 13.17-32.326 13.17ZM222.174 382.065l-43-42Q165.5 327.391 166 308.239t13.174-33.065q13.435-13.674 32.587-13.674t32.065 13.674l42.239 43q12.674 13.435 12.555 31.706-.12 18.272-12.555 31.946-12.674 13.674-31.445 13.413-18.772-.261-32.446-13.174Zm494 494.761-42.239-43q-12.674-13.435-12.674-32.087t12.674-31.565Q686.609 756.5 705.38 757q18.772.5 32.446 13.174l43 41.761Q794.5 824.609 794 843.761t-13.174 33.065Q767.391 890.5 748.239 890.5t-32.065-13.674Zm-42-494.761Q660.5 369.391 661 350.62q.5-18.772 13.174-32.446l41.761-43Q728.609 261.5 747.761 262t33.065 13.174q13.674 13.435 13.674 32.587t-13.674 32.065l-43 42.239q-13.435 12.674-31.706 12.555-18.272-.12-31.946-12.555Zm-495 494.761Q165.5 863.391 165.5 844.239t13.674-32.065l43-42.239q13.435-12.674 32.087-12.674t31.565 12.674Q299.5 782.609 299 801.38q-.5 18.772-13.174 32.446l-41.761 43Q231.391 890.5 212.239 890t-33.065-13.174ZM480 576Z"></path>
</svg>
<svg class="absolute transition-all scale-0 rotate-90 dark:rotate-0 dark:scale-100" fill="currentColor" height="24" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M480 936q-151 0-255.5-104.5T120 576q0-138 90-239.5T440 218q25-3 39 18t-1 44q-17 26-25.5 55t-8.5 61q0 90 63 153t153 63q31 0 61.5-9t54.5-25q21-14 43-1.5t19 39.5q-14 138-117.5 229T480 936Zm0-80q88 0 158-48.5T740 681q-20 5-40 8t-40 3q-123 0-209.5-86.5T364 396q0-20 3-40t8-40q-78 32-126.5 102T200 576q0 116 82 198t198 82Zm-10-270Z"></path>
</svg>
</button>
</nav>
</div>
</div>
</header>
<div class="flex-1"><div class="container flex-1 items-start md:grid md:grid-cols-[220px_minmax(0,1fr)] md:gap-6 lg:grid-cols-[240px_minmax(0,1fr)] lg:gap-10"><aside :aria-hidden="!showSidebar" :class="{ 'translate-x-0': showSidebar }" class="fixed inset-y-0 left-0 md:top-14 z-50 md:z-30 bg-background md:bg-transparent transition-all duration-100 -translate-x-full md:translate-x-0 ml-0 p-6 md:p-0 md:-ml-2 md:h-[calc(100vh-3.5rem)] w-5/6 md:w-full shrink-0 overflow-y-auto border-r border-border md:sticky" id="left-sidebar">
<a class="!justify-start text-sm md:!hidden bg-background" href="index.html"><span class="font-bold text-clip whitespace-nowrap">Operating Systems: updated 28 Dec 2023</span>
</a>
<div class="relative overflow-hidden md:overflow-auto my-4 md:my-0 h-[calc(100vh-8rem)] md:h-auto">
<div class="overflow-y-auto h-full w-full relative pr-6"><nav class="table w-full min-w-full my-6 lg:my-8">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="meta.html">About the Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="processes.html">Introduction to Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="files-io.html">Files and I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="scheduling.html">Process/Thread Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="mutualexclusion.html">Mutual Exclusion</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Deadlock</a></li>
<li class="toctree-l1"><a class="reference internal" href="ipc.html">IPC Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="kernelmm.html">Virtual Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="userlandmm.html">Userland Memory Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="storage.html">Storage and Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="fs.html">Implementing Files and Folders</a></li>
<li class="toctree-l1"><a class="reference internal" href="research.html">Storage Research at Loyola</a></li>
<li class="toctree-l1"><a class="reference internal" href="linux_vm.html">Installing a Linux Virtual Machine with VMware</a></li>
<li class="toctree-l1"><a class="reference internal" href="windows_vm.html">Installing a Windows Virtual Machine with VMware</a></li>
</ul>
</nav>
</div>
</div>
<button @click="showSidebar = false" class="absolute md:hidden right-4 top-4 rounded-sm opacity-70 transition-opacity hover:opacity-100" type="button">
<svg class="h-4 w-4" fill="currentColor" height="24" stroke="none" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M480 632 284 828q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536 576l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480 632Z"></path>
</svg>
</button>
</aside>
<main class="relative py-6 lg:gap-10 lg:py-8 xl:grid xl:grid-cols-[1fr_300px]">
<div class="w-full min-w-0 mx-auto">
<nav aria-label="breadcrumbs" class="flex items-center mb-4 space-x-1 text-sm text-muted-foreground">
<a class="overflow-hidden text-ellipsis whitespace-nowrap hover:text-foreground" href="index.html">
<span class="hidden md:inline">Operating Systems: updated 28 Dec 2023</span>
<svg aria-label="Home" class="md:hidden" fill="currentColor" height="18" stroke="none" viewbox="0 96 960 960" width="18" xmlns="http://www.w3.org/2000/svg">
<path d="M240 856h120V616h240v240h120V496L480 316 240 496v360Zm-80 80V456l320-240 320 240v480H520V696h-80v240H160Zm320-350Z"></path>
</svg>
</a>
<div class="mr-1">/</div><span aria-current="page" class="font-medium text-foreground overflow-hidden text-ellipsis whitespace-nowrap">Deadlock</span>
</nav>
<div id="content" role="main">
<section id="deadlock">
<h1>Deadlock<a class="headerlink" href="#deadlock" title="Link to this heading">¶</a></h1>
<section id="deadlock-definition">
<h2>Deadlock - definition<a class="headerlink" href="#deadlock-definition" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#deadlock-definition'">¶</a></h2>
<ul class="simple">
<li><p>Formal: A condition when two or more threads of execution are each waiting for resources in a cycle.</p></li>
<li><p>Informal: When two threads get into a chicken before the egg situation in locking.</p></li>
<li><p>When a deadlock condition occurs, unless otherwise broken, the threads of execution involved will remain halted until they are terminated externally.</p></li>
<li><p>If deadlock is possible, it may not always happen immediately. If it is possible it can happen eventually given the right timing.</p></li>
</ul>
</section>
<section id="dining-philosophers-problem">
<h2>Dining Philosophers Problem<a class="headerlink" href="#dining-philosophers-problem" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#dining-philosophers-problem'">¶</a></h2>
<ul class="simple">
<li><p>a philosopher can be either eating or thinking</p></li>
<li><p>philosophers cannot communicate with each other in any way</p></li>
<li><p>to eat, a philosopher needs both the right and left fork</p></li>
</ul>
</section>
<section id="dining-philosophers-deadlock-scenario">
<h2>Dining Philosophers - deadlock scenario<a class="headerlink" href="#dining-philosophers-deadlock-scenario" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#dining-philosophers-deadlock-scenario'">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">eat</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">pick</span> <span class="n">up</span> <span class="n">right</span> <span class="n">fork</span><span class="p">;</span>
        <span class="n">pick</span> <span class="n">up</span> <span class="n">left</span> <span class="n">fork</span><span class="p">;</span>
        <span class="n">proceed</span> <span class="k">with</span> <span class="n">eating</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>t = 0: p1, p2, p3, p4, p5 each pick up right fork</p></li>
<li><p>t = 1: p1 tries to pick up left fork, cannot proceed because p5 has it held</p></li>
<li><p>t = 2: p2 tries to pick up left fork, cannot proceed because p1 has it held</p></li>
<li><p>t = ……</p></li>
<li><p>The waiting operation will continue forever. Each philosopher has one fork in their hand. Each philosopher is waiting on a fork held by another</p></li>
</ul>
</section>
<section id="dining-philosophers-lock-graph">
<h2>Dining Philosophers - Lock Graph<a class="headerlink" href="#dining-philosophers-lock-graph" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#dining-philosophers-lock-graph'">¶</a></h2>
<ul class="simple">
<li><p>In the first algorithm, locks can be obtained in any order. Given this, it is possible to draw a cycle on the graph and deadlock.</p></li>
</ul>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/undirected_lock_graph.png"><img alt="Undirected Lock Graph" src="_images/undirected_lock_graph.png" style="width: 450px;"/></a>
</figure>
</section>
<section id="dining-philosophers">
<h2>Dining Philosophers<a class="headerlink" href="#dining-philosophers" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#dining-philosophers'">¶</a></h2>
<ul class="simple">
<li><p>What algorithm can we implement for eat() so that there will be no deadlock?</p></li>
<li><p>Why did we encounter deadlock?</p></li>
</ul>
</section>
<section id="dining-philosophers-solution-1">
<h2>Dining Philosophers - solution 1<a class="headerlink" href="#dining-philosophers-solution-1" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#dining-philosophers-solution-1'">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">eat</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="n">does</span> <span class="ow">not</span> <span class="n">have</span> <span class="n">both</span> <span class="n">forks</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">pickup</span> <span class="n">left</span> <span class="n">fork</span>
                <span class="k">if</span><span class="p">(</span><span class="n">can</span> <span class="n">pick</span> <span class="n">up</span> <span class="n">right</span> <span class="n">fork</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">pick</span> <span class="n">up</span> <span class="n">right</span> <span class="n">fork</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">put</span> <span class="n">down</span> <span class="n">left</span> <span class="n">fork</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">proceed</span> <span class="k">with</span> <span class="n">eating</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>this solution works because it obtains both forks as an atomic operation: if the philosopher cannot obtain the second fork, they put down their held fork. either they get both forks or no forks.</p></li>
<li><p>this prevents a cycle because of the check operation</p></li>
</ul>
</section>
<section id="dining-philosophers-solution-2">
<h2>Dining Philosophers - solution 2<a class="headerlink" href="#dining-philosophers-solution-2" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#dining-philosophers-solution-2'">¶</a></h2>
<ul class="simple">
<li><p>each fork is assigned a number</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">eat</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">pick</span> <span class="n">up</span> <span class="n">fork</span> <span class="k">with</span> <span class="n">lower</span> <span class="n">number</span>
        <span class="n">pick</span> <span class="n">up</span> <span class="n">fork</span> <span class="k">with</span> <span class="n">higher</span> <span class="n">number</span>
        <span class="n">proceed</span> <span class="k">with</span> <span class="n">eating</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>this solution works because the resources are assigned a partial order. this effectively reduces the number of possible edges in the order of locks that can be obtained in the resource lock graph. the graph is reduced to an directional acyclic graph which by definition cannot have cycles and cannot deadlock.</p></li>
<li><p>In solution 2, since the order of locks is agreed upon, the graph becomes directed and acyclic.</p></li>
<li><p>Given these rules, you cannot draw a cycle on this graph and cannot deadlock</p></li>
</ul>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/directed_lock_graph.png"><img alt="Undirected Lock Graph" src="_images/directed_lock_graph.png" style="width: 450px;"/></a>
</figure>
</section>
<section id="dijkstra-s-solution-bankers-algorithm">
<h2>Dijkstra’s Solution / Bankers Algorithm<a class="headerlink" href="#dijkstra-s-solution-bankers-algorithm" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#dijkstra-s-solution-bankers-algorithm'">¶</a></h2>
<ul class="simple">
<li><p>Solution #2 to the dining philosopher’s problem is also known as Dijkstra’s solution or the banker’s algorithm</p></li>
<li><dl class="simple">
<dt>Up sides to this solution</dt><dd><ul>
<li><p>Simple to implement and verify lock ordering.</p></li>
<li><p>Multi-lock algorithms can be implemented by comparing memory addresses. i.e. mutexes can be locked in the order they appear in memory</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Down sides to this solution</dt><dd><ul>
<li><p>If you examine the undirected cyclic graph earlier, there are several permutations of acquiring locks that do not deadlock.</p></li>
<li><p>In the directed acyclic graph, all permutations are deadlock free, but the total number of deadlock free permutations is much less than in the undirected cyclic graph</p></li>
<li><p>Because of these issues, the total concurrency possible is less than optimal</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="optimization-to-dijkstra-s-solution">
<h2>Optimization to Dijkstra’s Solution<a class="headerlink" href="#optimization-to-dijkstra-s-solution" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#optimization-to-dijkstra-s-solution'">¶</a></h2>
<ul class="simple">
<li><p>Solution #1 represents an optimization to Dijkstra’s solution.</p></li>
<li><p>In solution #1, the graph remains undirected and cyclic, but the heuristic is changed to only obtain both resources if they can be obtained atomically.</p></li>
<li><p>In solution #1, all of the possible deadlock free permutations can be achieved. Because of this, more concurrency is possible.</p></li>
<li><p>The downside to solution #1 is that it is typically more complex to implement</p></li>
</ul>
</section>
<section id="deadlock-avoidance-implementation">
<h2>Deadlock Avoidance Implementation<a class="headerlink" href="#deadlock-avoidance-implementation" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#deadlock-avoidance-implementation'">¶</a></h2>
<ul class="simple">
<li><p>aka. Banker’s algorithm</p></li>
<li><p>aka. Dijkstra’s solution</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">struct</span> <span class="p">{</span>
        <span class="nb">int</span> <span class="n">LockNumber</span><span class="p">;</span>
        <span class="n">void</span><span class="o">*</span> <span class="n">LockObject</span><span class="p">;</span>
<span class="p">}</span> <span class="n">lock</span><span class="p">;</span>

<span class="n">void</span> <span class="n">multi_lock</span><span class="p">(</span><span class="n">lock</span><span class="o">*</span> <span class="n">locks</span><span class="p">,</span> <span class="nb">int</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sort</span><span class="p">(</span><span class="n">locks</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">lock</span><span class="p">(</span><span class="n">locks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="deadlock-prevention-implementation">
<h2>Deadlock Prevention Implementation<a class="headerlink" href="#deadlock-prevention-implementation" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#deadlock-prevention-implementation'">¶</a></h2>
<ul class="simple">
<li><p>aka. optimization to Dijkstra’s solution</p></li>
<li><p>This is just one implementation approach. Others involving lock tables or coordinators also exist</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>typedef struct {
        int LockNumber;
        void* LockObject;
} lock;

void multi_lock(lock* locks, int count) {
        while(1) {
                int i = 0;
                for(i = 0; i &lt; count; i++) {
                        if(!try_lock(locks[i])) {
                                for(int j = 0; j &lt; i; j++) {
                                        unlock(locks[j]);
                                }
                              break;
                        }
                }
                if(i == count) {
                        return;
                }
        }
}
</pre></div>
</div>
</section>
<section id="example-of-deadlock">
<h2>Example of Deadlock<a class="headerlink" href="#example-of-deadlock" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#example-of-deadlock'">¶</a></h2>
<ul class="simple">
<li><p>Where is the Deadlock?</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">method1</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">a</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
        <span class="n">method2</span><span class="p">();</span>
        <span class="n">a</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">method2</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">b</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
        <span class="n">c</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
        <span class="n">b</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
        <span class="n">c</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">method3</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">c</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
        <span class="n">method2</span><span class="p">();</span>
        <span class="n">method4</span><span class="p">();</span>
        <span class="n">c</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">method4</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">d</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
        <span class="n">d</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="multi-lock-solutions-in-windows">
<h2>Multi-Lock Solutions in Windows<a class="headerlink" href="#multi-lock-solutions-in-windows" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#multi-lock-solutions-in-windows'">¶</a></h2>
<ul class="simple">
<li><p>C++ method in Windows is WaitForMultipleObjects().</p></li>
<li><p>The method accepts N many lock handles</p></li>
<li><dl class="simple">
<dt>This method accepts many types of resources and locks:</dt><dd><ul>
<li><p>events</p></li>
<li><p>mutexes</p></li>
<li><p>semaphores</p></li>
<li><p>timers</p></li>
<li><p>and many others…</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="multi-lock-solutions-in-linux-minix">
<h2>Multi-Lock Solutions in Linux/Minix<a class="headerlink" href="#multi-lock-solutions-in-linux-minix" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#multi-lock-solutions-in-linux-minix'">¶</a></h2>
<ul class="simple">
<li><p>To my knowledge, there are no multi-lock solutions provided for free in Linux or Minix</p></li>
<li><p>The general rule of thumb is to try to avoid multi-locking if possible by design or if it is necessary to use the memory order of the locks as an ordering.</p></li>
<li><p>If using shared memory semaphores, memory ordering WILL NOT work since virtual addresses will not be reliable. In this case, lock ordering must be enforced by some other mechanism such as storing locks in an array and locking them in the array’s order.</p></li>
</ul>
</section>
<section id="deadlock-with-lock-ordering">
<h2>Deadlock with Lock Ordering<a class="headerlink" href="#deadlock-with-lock-ordering" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#deadlock-with-lock-ordering'">¶</a></h2>
<ul class="simple">
<li><p>While having multiple locks obtained out of order can lead to deadlock, it is possible for correctly ordered locks to end up in deadlock in other ways.</p></li>
<li><dl class="simple">
<dt>If an executing thread locks a resource and fails to release the lock, any other thread trying to obtain the lock will be deadlock. This can occur for one or more of the following reasons:</dt><dd><ul>
<li><p>Programmer error: there is no call to release a lock</p></li>
<li><p>A thread crashes without releasing a lock</p></li>
<li><p>The condition for releasing a lock is never met (infinite loop, poorly defined rules in a monitor, etc..)</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>These types of deadlock are practically more difficult to handle.</p></li>
</ul>
</section>
<section id="starvation">
<h2>Starvation<a class="headerlink" href="#starvation" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#starvation'">¶</a></h2>
<ul class="simple">
<li><p>Starvation is a close cousin to deadlock. Starvation means that practically, one thread will have exclusive lock on a resource and one or more threads will not.</p></li>
<li><p>This is similar to a scheduling problem in terms of fairness.</p></li>
<li><p>Example live lock problem:</p></li>
<li><p>Thread1:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Queue _queue = new Queue();
Mutex _mutex = new Mutex();
void add() {
        int value = 0;
        while(1) {
                _mutex-»Lock();
                while(_queue-»count() » 0) {
                        value += _queue-»Dequeue();
                        printf("current value = %d\n", value);
                }
                _mutex-»Unlock();
        }
}
</pre></div>
</div>
<ul class="simple">
<li><p>Thread2:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>void read_values() {
        while(1) {
                int value = 0;
                _mutex-»Lock();
                scanf("%d\n", &amp;value);
                _queue-»Enqueue(value);
                _mutex-»Unlock();
        }
}
</pre></div>
</div>
<ul class="simple">
<li><p>There are two potential starvation problems here. Can you spot them?</p></li>
<li><p>In thread1, we make a call to printf(). This will cause thread1 to go to sleep at which time, thread2 will not be able to obtain the lock.</p></li>
<li><p>In thread2, we make a call to scanf(), while waiting for input the lock is held and thread1 will not be able to acquire the lock</p></li>
<li><p>How can we make this code better?</p></li>
<li><p>Thread1:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Queue _queue = new Queue();
Mutex _mutex = new Mutex();
void add() {
        int value = 0;
        while(1) {
                _mutex-»Lock();
                while(_queue-»count() » 0) {
                        value += _queue-»Dequeue();
                        _mutex-&gt;Unlock();
                        printf("current value = %d\n", value);
                        _mutex-&gt;Lock();
                }
                _mutex-»Unlock();
        }
}
</pre></div>
</div>
<ul class="simple">
<li><p>Thread2:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>void read_values() {
        while(1) {
                int value = 0;
                scanf("%d\n", &amp;value);
                _mutex-»Lock();
                _queue-»Enqueue(value);
                _mutex-»Unlock();
        }
}
</pre></div>
</div>
<ul class="simple">
<li><p>In this version of the code, the locks are not held during I/O operations like printf or scanf (which call read and write).</p></li>
<li><p>Because locks are not held during blocking operations, locks and unlocks will occur more often which will reduce the average waiting time to receive a lock.</p></li>
</ul>
</section>
<section id="guidlines-to-avoid-starvation">
<h2>Guidlines to Avoid Starvation<a class="headerlink" href="#guidlines-to-avoid-starvation" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#guidlines-to-avoid-starvation'">¶</a></h2>
<ul class="simple">
<li><p>Where possible, limit locks to computationally bound code</p></li>
<li><p>Keep critical sections short. If a computation is longer running, design code to give up a lock periodically.</p></li>
<li><dl class="simple">
<dt>If possible, make copies in critical sections and perform computations outside of locks. An example could be:</dt><dd><ol class="arabic simple">
<li><p>acquire lock</p></li>
<li><p>copy item in queue</p></li>
<li><p>update item as “in progress”</p></li>
<li><p>release lock</p></li>
<li><p>perform computation</p></li>
<li><p>acquire lock</p></li>
<li><p>remove item from queue</p></li>
<li><p>release lock﻿</p></li>
</ol>
</dd>
</dl>
</li>
<li><p>Make sure the lock library you use has some fairness guarantee.</p></li>
</ul>
</section>
<section id="livelock">
<h2>Livelock<a class="headerlink" href="#livelock" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#livelock'">¶</a></h2>
<ul class="simple">
<li><p>Livelock is similar to deadlock.</p></li>
<li><p>Livelock is basically a race condition in avoidance of deadlock.</p></li>
<li><p>An example of livelock would be if one process is trying to multi-lock by testing, then acquiring each lock in turn, and another process is doing the same, they could both block each other by their corrective actions.</p></li>
<li><p>Example:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">thread1</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">a</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">trylock</span><span class="p">())</span> <span class="p">{</span>
                        <span class="o">//</span><span class="n">do</span> <span class="n">work</span>
                        <span class="n">b</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="n">a</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">thread2</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">b</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">trylock</span><span class="p">())</span> <span class="p">{</span>
                        <span class="o">//</span><span class="n">do</span> <span class="n">work</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="n">b</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>t0: thread1 locks a, context switch</p></li>
<li><p>t1: thread2 locks b, tries to lock a, fails, context switch</p></li>
<li><p>t2: thread1 tries to lock b, fails, unlocks a, context switch</p></li>
<li><p>t3: thread 2 unlocks b, context switch</p></li>
</ul>
</section>
<section id="lock-fairness">
<h2>Lock Fairness<a class="headerlink" href="#lock-fairness" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#lock-fairness'">¶</a></h2>
<ul class="simple">
<li><p>Lock fairness is best described as having each executing thread waiting for a lock having a similar average wait time for that lock.</p></li>
<li><p>Locks that are unfair can lead to resource starvation.</p></li>
<li><dl class="simple">
<dt>The two most common approaches involve:</dt><dd><ul>
<li><p>FIFO queues - common</p></li>
<li><p>Lock scheduler with a time table and history - not common</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="lock-fairness-pros-cons">
<h2>Lock Fairness. Pros / Cons<a class="headerlink" href="#lock-fairness-pros-cons" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#lock-fairness-pros-cons'">¶</a></h2>
<ul class="simple">
<li><p>Remember, while the word ‘fair’ sounds good, that ‘fairness’ comes at some expense.</p></li>
<li><p>The key point to remember, is that when a thread is “chosen” to acquire a lock, there will be a non zero time between that choice and when that thread executes. That can be thought of as the “fairness cost”.</p></li>
<li><dl class="simple">
<dt>Pros:</dt><dd><ul>
<li><p>Reduces starvation</p></li>
<li><p>Creates more predictable execution patterns</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Cons:</dt><dd><ul>
<li><p>If a thread locks in a loop, letting a thread re-acquire a lock if its quantum isn’t complete can improve total performance. Fair locks don’t always allow for a lock to be re-acquired if the quantum isn’t finished. This can lead to shorter quantums which will hurt throughput.</p></li>
<li><p>Lock fairness can create short quantums for short locks. This can in-turn hurt locality</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
</section>
</div></div><aside class="hidden text-sm xl:block" id="right-sidebar">
<div class="sticky top-16 -mt-10 max-h-[calc(var(--vh)-4rem)] overflow-y-auto pt-6 space-y-2"><p class="font-medium">On this page</p>
<ul>
<li><a :data-current="activeSection === '#deadlock-definition'" class="reference internal" href="#deadlock-definition">Deadlock - definition</a></li>
<li><a :data-current="activeSection === '#dining-philosophers-problem'" class="reference internal" href="#dining-philosophers-problem">Dining Philosophers Problem</a></li>
<li><a :data-current="activeSection === '#dining-philosophers-deadlock-scenario'" class="reference internal" href="#dining-philosophers-deadlock-scenario">Dining Philosophers - deadlock scenario</a></li>
<li><a :data-current="activeSection === '#dining-philosophers-lock-graph'" class="reference internal" href="#dining-philosophers-lock-graph">Dining Philosophers - Lock Graph</a></li>
<li><a :data-current="activeSection === '#dining-philosophers'" class="reference internal" href="#dining-philosophers">Dining Philosophers</a></li>
<li><a :data-current="activeSection === '#dining-philosophers-solution-1'" class="reference internal" href="#dining-philosophers-solution-1">Dining Philosophers - solution 1</a></li>
<li><a :data-current="activeSection === '#dining-philosophers-solution-2'" class="reference internal" href="#dining-philosophers-solution-2">Dining Philosophers - solution 2</a></li>
<li><a :data-current="activeSection === '#dijkstra-s-solution-bankers-algorithm'" class="reference internal" href="#dijkstra-s-solution-bankers-algorithm">Dijkstra’s Solution / Bankers Algorithm</a></li>
<li><a :data-current="activeSection === '#optimization-to-dijkstra-s-solution'" class="reference internal" href="#optimization-to-dijkstra-s-solution">Optimization to Dijkstra’s Solution</a></li>
<li><a :data-current="activeSection === '#deadlock-avoidance-implementation'" class="reference internal" href="#deadlock-avoidance-implementation">Deadlock Avoidance Implementation</a></li>
<li><a :data-current="activeSection === '#deadlock-prevention-implementation'" class="reference internal" href="#deadlock-prevention-implementation">Deadlock Prevention Implementation</a></li>
<li><a :data-current="activeSection === '#example-of-deadlock'" class="reference internal" href="#example-of-deadlock">Example of Deadlock</a></li>
<li><a :data-current="activeSection === '#multi-lock-solutions-in-windows'" class="reference internal" href="#multi-lock-solutions-in-windows">Multi-Lock Solutions in Windows</a></li>
<li><a :data-current="activeSection === '#multi-lock-solutions-in-linux-minix'" class="reference internal" href="#multi-lock-solutions-in-linux-minix">Multi-Lock Solutions in Linux/Minix</a></li>
<li><a :data-current="activeSection === '#deadlock-with-lock-ordering'" class="reference internal" href="#deadlock-with-lock-ordering">Deadlock with Lock Ordering</a></li>
<li><a :data-current="activeSection === '#starvation'" class="reference internal" href="#starvation">Starvation</a></li>
<li><a :data-current="activeSection === '#guidlines-to-avoid-starvation'" class="reference internal" href="#guidlines-to-avoid-starvation">Guidlines to Avoid Starvation</a></li>
<li><a :data-current="activeSection === '#livelock'" class="reference internal" href="#livelock">Livelock</a></li>
<li><a :data-current="activeSection === '#lock-fairness'" class="reference internal" href="#lock-fairness">Lock Fairness</a></li>
<li><a :data-current="activeSection === '#lock-fairness-pros-cons'" class="reference internal" href="#lock-fairness-pros-cons">Lock Fairness. Pros / Cons</a></li>
</ul>
</div>
</aside>
</main>
</div>
</div><footer class="py-6 border-t border-border md:py-0">
<div class="container flex flex-col items-center justify-between gap-4 md:h-24 md:flex-row">
<div class="flex flex-col items-center gap-4 px-8 md:flex-row md:gap-2 md:px-0">
<p class="text-sm leading-loose text-center text-muted-foreground md:text-left">© 2013-2020, Operating Systems Faculty at Loyola University Chicago Built with <a class="font-medium underline underline-offset-4" href="https://www.sphinx-doc.org" rel="noreferrer">Sphinx 7.2.6</a></p>
</div>
</div>
</footer>
</div>
<script src="_static/documentation_options.js?v=360e3fcb"></script>
<script src="_static/doctools.js?v=888ff710"></script>
<script src="_static/sphinx_highlight.js?v=dc90522c"></script>
<script defer="defer" src="_static/theme.js?v=e8bd915e"></script>
</body>
</html>