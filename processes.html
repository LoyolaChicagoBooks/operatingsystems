<!DOCTYPE html>

<html :class="{'dark': darkMode === 'dark' || (darkMode === 'system' &amp;&amp; window.matchMedia('(prefers-color-scheme: dark)').matches)}" class="scroll-smooth" lang="en" x-data="{ darkMode: localStorage.getItem('darkMode') || localStorage.setItem('darkMode', 'system'), activeSection: '' }" x-init="$watch('darkMode', val =&gt; localStorage.setItem('darkMode', val))">
<head>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta charset="utf-8"/>
<meta content="white" media="(prefers-color-scheme: light)" name="theme-color"/>
<meta content="black" metia="(prefers-color-scheme: dark)" name="theme-color"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Introduction to Processes | Operating Systems: updated 04 Dec 2023</title>
<meta content="Introduction to Processes | Operating Systems: updated 04 Dec 2023" property="og:title"/>
<meta content="Introduction to Processes | Operating Systems: updated 04 Dec 2023" name="twitter:title"/>
<link href="_static/pygments.css" rel="stylesheet"/>
<link href="_static/theme.css" rel="stylesheet"/>
<link href="search.html" rel="search" title="Search"/>
<link href="genindex.html" rel="index" title="Index"/>
<link href="files-io.html" rel="next" title="Files and I/O"/>
<link href="introduction.html" rel="prev" title="Introduction"/>
<script>
    <!-- Prevent Flash of wrong theme -->
      const userPreference = localStorage.getItem('darkMode');
      let mode;
      if (userPreference === 'dark' || window.matchMedia('(prefers-color-scheme: dark)').matches) {
        mode = 'dark';
        document.documentElement.classList.add('dark');
      } else {
        mode = 'light';
      }
      if (!userPreference) {localStorage.setItem('darkMode', mode)}
    </script>
<script src="_static/documentation_options.js?v=a0bb73f4"></script>
<script src="_static/doctools.js?v=888ff710"></script>
<script src="_static/sphinx_highlight.js?v=dc90522c"></script>
<script defer="" src="_static/theme.ad172c0f1249198ea036.js"></script>
</head>
<body :class="{ 'overflow-hidden': showSidebar }" class="min-h-screen font-sans antialiased bg-background text-foreground" x-data="{ showSidebar: false }">
<div @click.self="showSidebar = false" class="fixed inset-0 z-50 overflow-hidden bg-background/80 backdrop-blur-sm" x-cloak="" x-show="showSidebar"></div><div class="relative flex flex-col min-h-screen" id="page"><a class="absolute top-0 left-0 z-[100] block bg-background p-4 text-xl transition -translate-x-full opacity-0 focus:translate-x-0 focus:opacity-100" href="#content">
      Skip to content
    </a><header class="sticky top-0 z-40 w-full border-b shadow-sm border-border supports-backdrop-blur:bg-background/60 bg-background/95 backdrop-blur"><div class="container flex items-center h-14">
<div class="hidden mr-4 md:flex">
<a class="flex items-center mr-6" href="index.html"><span class="hidden font-bold sm:inline-block text-clip whitespace-nowrap">Operating Systems: updated 04 Dec 2023</span>
</a></div><button @click="showSidebar = true" class="inline-flex items-center justify-center h-10 px-0 py-2 mr-2 text-base font-medium transition-colors rounded-md hover:text-accent-foreground hover:bg-transparent md:hidden" type="button">
<svg aria-hidden="true" fill="currentColor" height="24" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M152.587 825.087q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440Zm0-203.587q-19.152 0-32.326-13.174T107.087 576q0-19.152 13.174-32.326t32.326-13.174h320q19.152 0 32.326 13.174T518.087 576q0 19.152-13.174 32.326T472.587 621.5h-320Zm0-203.587q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440ZM708.913 576l112.174 112.174q12.674 12.674 12.674 31.826t-12.674 31.826Q808.413 764.5 789.261 764.5t-31.826-12.674l-144-144Q600 594.391 600 576t13.435-31.826l144-144q12.674-12.674 31.826-12.674t31.826 12.674q12.674 12.674 12.674 31.826t-12.674 31.826L708.913 576Z"></path>
</svg>
<span class="sr-only">Toggle navigation menu</span>
</button>
<div class="flex items-center justify-between flex-1 space-x-2 sm:space-x-4 md:justify-end">
<div class="flex-1 w-full md:w-auto md:flex-none">
<form @keydown.k.window.meta="$refs.search.focus()" action="search.html" class="relative flex items-center group" id="searchbox" method="get">
<input aria-label="Search the docs" class="inline-flex items-center font-medium transition-colors bg-transparent focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ring-offset-background border border-input hover:bg-accent focus:bg-accent hover:text-accent-foreground focus:text-accent-foreground hover:placeholder-accent-foreground py-2 px-4 relative h-9 w-full justify-start rounded-[0.5rem] text-sm text-muted-foreground sm:pr-12 md:w-40 lg:w-64" id="search-input" name="q" placeholder="Search ..." type="search" x-ref="search"/>
<kbd class="pointer-events-none absolute right-1.5 top-2 hidden h-5 select-none text-muted-foreground items-center gap-1 rounded border border-border bg-muted px-1.5 font-mono text-[10px] font-medium opacity-100 sm:flex group-hover:bg-accent group-hover:text-accent-foreground">
<span class="text-xs">⌘</span>
      K
    </kbd>
</form>
</div>
<nav class="flex items-center space-x-1">
<button @click="darkMode = darkMode === 'light' ? 'dark' : 'light'" class="relative inline-flex items-center justify-center px-0 text-sm font-medium transition-colors rounded-md hover:bg-accent hover:text-accent-foreground h-9 w-9" type="button">
<svg class="absolute transition-all scale-100 rotate-0 dark:-rotate-90 dark:scale-0" fill="currentColor" height="24" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M480 685q45.456 0 77.228-31.772Q589 621.456 589 576q0-45.456-31.772-77.228Q525.456 467 480 467q-45.456 0-77.228 31.772Q371 530.544 371 576q0 45.456 31.772 77.228Q434.544 685 480 685Zm0 91q-83 0-141.5-58.5T280 576q0-83 58.5-141.5T480 376q83 0 141.5 58.5T680 576q0 83-58.5 141.5T480 776ZM80 621.5q-19.152 0-32.326-13.174T34.5 576q0-19.152 13.174-32.326T80 530.5h80q19.152 0 32.326 13.174T205.5 576q0 19.152-13.174 32.326T160 621.5H80Zm720 0q-19.152 0-32.326-13.174T754.5 576q0-19.152 13.174-32.326T800 530.5h80q19.152 0 32.326 13.174T925.5 576q0 19.152-13.174 32.326T880 621.5h-80Zm-320-320q-19.152 0-32.326-13.174T434.5 256v-80q0-19.152 13.174-32.326T480 130.5q19.152 0 32.326 13.174T525.5 176v80q0 19.152-13.174 32.326T480 301.5Zm0 720q-19.152 0-32.326-13.17Q434.5 995.152 434.5 976v-80q0-19.152 13.174-32.326T480 850.5q19.152 0 32.326 13.174T525.5 896v80q0 19.152-13.174 32.33-13.174 13.17-32.326 13.17ZM222.174 382.065l-43-42Q165.5 327.391 166 308.239t13.174-33.065q13.435-13.674 32.587-13.674t32.065 13.674l42.239 43q12.674 13.435 12.555 31.706-.12 18.272-12.555 31.946-12.674 13.674-31.445 13.413-18.772-.261-32.446-13.174Zm494 494.761-42.239-43q-12.674-13.435-12.674-32.087t12.674-31.565Q686.609 756.5 705.38 757q18.772.5 32.446 13.174l43 41.761Q794.5 824.609 794 843.761t-13.174 33.065Q767.391 890.5 748.239 890.5t-32.065-13.674Zm-42-494.761Q660.5 369.391 661 350.62q.5-18.772 13.174-32.446l41.761-43Q728.609 261.5 747.761 262t33.065 13.174q13.674 13.435 13.674 32.587t-13.674 32.065l-43 42.239q-13.435 12.674-31.706 12.555-18.272-.12-31.946-12.555Zm-495 494.761Q165.5 863.391 165.5 844.239t13.674-32.065l43-42.239q13.435-12.674 32.087-12.674t31.565 12.674Q299.5 782.609 299 801.38q-.5 18.772-13.174 32.446l-41.761 43Q231.391 890.5 212.239 890t-33.065-13.174ZM480 576Z"></path>
</svg>
<svg class="absolute transition-all scale-0 rotate-90 dark:rotate-0 dark:scale-100" fill="currentColor" height="24" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M480 936q-151 0-255.5-104.5T120 576q0-138 90-239.5T440 218q25-3 39 18t-1 44q-17 26-25.5 55t-8.5 61q0 90 63 153t153 63q31 0 61.5-9t54.5-25q21-14 43-1.5t19 39.5q-14 138-117.5 229T480 936Zm0-80q88 0 158-48.5T740 681q-20 5-40 8t-40 3q-123 0-209.5-86.5T364 396q0-20 3-40t8-40q-78 32-126.5 102T200 576q0 116 82 198t198 82Zm-10-270Z"></path>
</svg>
</button>
</nav>
</div>
</div>
</header>
<div class="flex-1"><div class="container flex-1 items-start md:grid md:grid-cols-[220px_minmax(0,1fr)] md:gap-6 lg:grid-cols-[240px_minmax(0,1fr)] lg:gap-10"><aside :aria-hidden="!showSidebar" :class="{ 'translate-x-0': showSidebar }" class="fixed inset-y-0 left-0 md:top-14 z-50 md:z-30 bg-background md:bg-transparent transition-all duration-100 -translate-x-full md:translate-x-0 ml-0 p-6 md:p-0 md:-ml-2 md:h-[calc(100vh-3.5rem)] w-5/6 md:w-full shrink-0 overflow-y-auto border-r border-border md:sticky" id="left-sidebar">
<a class="!justify-start text-sm md:!hidden bg-background" href="index.html"><span class="font-bold text-clip whitespace-nowrap">Operating Systems: updated 04 Dec 2023</span>
</a>
<div class="relative overflow-hidden md:overflow-auto my-4 md:my-0 h-[calc(100vh-8rem)] md:h-auto">
<div class="overflow-y-auto h-full w-full relative pr-6"><nav class="table w-full min-w-full my-6 lg:my-8">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="meta.html">About the Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Introduction to Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="files-io.html">Files and I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="scheduling.html">Process/Thread Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="mutualexclusion.html">Mutual Exclusion</a></li>
<li class="toctree-l1"><a class="reference internal" href="deadlock.html">Deadlock</a></li>
<li class="toctree-l1"><a class="reference internal" href="ipc.html">IPC Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="kernelmm.html">Virtual Memory</a></li>
<li class="toctree-l1"><a class="reference internal" href="userlandmm.html">Userland Memory Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="storage.html">Storage and Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="fs.html">Implementing Files and Folders</a></li>
<li class="toctree-l1"><a class="reference internal" href="research.html">Storage Research at Loyola</a></li>
<li class="toctree-l1"><a class="reference internal" href="linux_vm.html">Installing a Linux Virtual Machine with VMware</a></li>
<li class="toctree-l1"><a class="reference internal" href="windows_vm.html">Installing a Windows Virtual Machine with VMware</a></li>
</ul>
</nav>
</div>
</div>
<button @click="showSidebar = false" class="absolute md:hidden right-4 top-4 rounded-sm opacity-70 transition-opacity hover:opacity-100" type="button">
<svg class="h-4 w-4" fill="currentColor" height="24" stroke="none" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M480 632 284 828q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536 576l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480 632Z"></path>
</svg>
</button>
</aside>
<main class="relative py-6 lg:gap-10 lg:py-8 xl:grid xl:grid-cols-[1fr_300px]">
<div class="w-full min-w-0 mx-auto">
<nav aria-label="breadcrumbs" class="flex items-center mb-4 space-x-1 text-sm text-muted-foreground">
<a class="overflow-hidden text-ellipsis whitespace-nowrap hover:text-foreground" href="index.html">
<span class="hidden md:inline">Operating Systems: updated 04 Dec 2023</span>
<svg aria-label="Home" class="md:hidden" fill="currentColor" height="18" stroke="none" viewbox="0 96 960 960" width="18" xmlns="http://www.w3.org/2000/svg">
<path d="M240 856h120V616h240v240h120V496L480 316 240 496v360Zm-80 80V456l320-240 320 240v480H520V696h-80v240H160Zm320-350Z"></path>
</svg>
</a>
<div class="mr-1">/</div><span aria-current="page" class="font-medium text-foreground overflow-hidden text-ellipsis whitespace-nowrap">Introduction to Processes</span>
</nav>
<div id="content" role="main">
<section id="introduction-to-processes">
<h1>Introduction to Processes<a class="headerlink" href="#introduction-to-processes" title="Link to this heading">¶</a></h1>
<ul class="simple">
<li><p>An executing program or job</p></li>
<li><p>Components</p>
<ul>
<li><p>Memory address space</p></li>
<li><p>Program image</p></li>
<li><p>Handles to files</p></li>
<li><p>Interprocess communication</p></li>
</ul>
</li>
<li><p>Every process has a parent</p>
<ul>
<li><p>top most process in UNIX is “init”</p></li>
<li><p>Windows top most processes are:</p>
<ul>
<li><p>system.exe - OS kernel</p></li>
<li><p>csrss.exe - handles user mode win32 calls</p></li>
<li><p>wininit.exe - manages system services</p></li>
<li><p>explorer.exe - OS shell</p></li>
<li><p>winlogin.exe - OS login service</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<section id="process-memory-layout">
<h2>Process Memory Layout<a class="headerlink" href="#process-memory-layout" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#process-memory-layout'">¶</a></h2>
<ul class="simple">
<li><p>Text - machine instructions of a program.</p></li>
<li><p>Data - initialized static data and constants</p></li>
<li><p>BSS - uninitialized static data</p></li>
<li><p>Heap - dynamic memory of a process</p>
<ul>
<li><p>one or more per process</p></li>
</ul>
</li>
<li><p>Stack - local variables, call stack, return values</p>
<ul>
<li><p>one per thread for kernel mode threads</p></li>
<li><p>one per n-threads for user mode threads</p></li>
</ul>
</li>
<li><p>layout of and allocation of text, data, bss, and initial values for
first thread’s stack and heap are the responsibility of the loader</p></li>
<li><p>management of stack and heap are through the process’s runtime
library and program instructions</p></li>
</ul>
</section>
<section id="id1">
<h2>Process Memory Layout<a class="headerlink" href="#id1" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#id1'">¶</a></h2>
<blockquote>
<div><figure class="align-center" id="id3">
<img alt="Memory Layout" src="_images/memory_layout.png"/>
<figcaption>
<p><span class="caption-text">Memory Layout</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</div></blockquote>
</section>
<section id="multithreaded-memory-layout">
<h2>Multithreaded Memory Layout<a class="headerlink" href="#multithreaded-memory-layout" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#multithreaded-memory-layout'">¶</a></h2>
<blockquote>
<div><figure class="align-center" id="id4">
<img alt="Memory Layout for Multithreaded Programs" src="_images/memory_layout_multithreaded.png"/>
<figcaption>
<p><span class="caption-text">Memory Layout for Multithreaded Programs</span><a class="headerlink" href="#id4" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</div></blockquote>
</section>
<section id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#preliminaries'">¶</a></h2>
<ul class="simple">
<li><p>Code for examples in maintained at <a class="reference external" href="https://github.com/gkthiruvathukal/systems-code-examples">https://github.com/gkthiruvathukal/systems-code-examples</a></p></li>
<li><p>You can use <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/gkthiruvathukal/systems-code-examples</span></code> to clone to a folder <code class="docutils literal notranslate"><span class="pre">systems-code-examples</span></code>.</p></li>
<li><p>All subsequent examples that are full-working demonstrations will be referenced as <code class="docutils literal notranslate"><span class="pre">systems-code-examples/&lt;example-name&gt;</span></code>.</p></li>
<li><p>To run examples, make sure you have <cite>gcc</cite>, <cite>cmake</cite>, and <cite>make</cite> on your computer.</p></li>
<li><p>We only have tested on Ubuntu Linux, MacOS, and Windows Subsystem for Linux 2 (with Ubuntu 20.04 LTS). Most others should work.</p></li>
</ul>
</section>
<section id="examine-process-layout-example">
<h2>Examine Process Layout Example<a class="headerlink" href="#examine-process-layout-example" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#examine-process-layout-example'">¶</a></h2>
<ul>
<li><p>Most of our examples are written in C with some C++.</p></li>
<li><p>Getting the code</p>
<p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/gkthiruvathukal/systems-code-examples</span></code>
<code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">systems-code-examples/c_intro</span></code></p>
</li>
<li><p>Generate the <cite>Makefile</cite> using <cite>cmake</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd c_intro
$ cmake .
-- The C compiler identification is GNU 9.3.0
-- The CXX compiler identification is GNU 9.3.0
-- Check for working C compiler: /usr/bin/cc
-- Check for working C compiler: /usr/bin/cc -- works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Detecting C compile features
-- Detecting C compile features - done
-- Check for working CXX compiler: /usr/bin/c++
-- Check for working CXX compiler: /usr/bin/c++ -- works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Detecting CXX compile features
-- Detecting CXX compile features - done
&gt;&gt; Linux
-- Configuring done
-- Generating done
-- Build files have been written to: /home/gkt/Work/systems-code-examples/c_intro
</pre></div>
</div>
</li>
<li><p>Run <cite>make</cite> to crate the executable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ make
Scanning dependencies of target c-intro-demo
[ 20%] Building CXX object CMakeFiles/c-intro-demo.dir/main.cc.o
[ 40%] Building CXX object CMakeFiles/c-intro-demo.dir/debug.cc.o
[ 60%] Building CXX object CMakeFiles/c-intro-demo.dir/list.cc.o
[ 80%] Building CXX object CMakeFiles/c-intro-demo.dir/tests.cc.o
[100%] Linking CXX executable bin/c-intro-demo
[100%] Built target c-intro-demo
</pre></div>
</div>
</li>
<li><p>Note that for all of our examples, the output executable appears in the <cite>bin</cite> subdirectory.</p></li>
<li><p>Note also that almost all of our examples use <cite>cmake</cite> and <cite>make</cite> as shown here.</p></li>
<li><p>Run the <cite>layout</cite> shell script, which shows the size of the text, data, and bss in <em>bytes</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./layout

section               size   addr
.text                 3957    4352
.data                   24   20480
.bss                     8   20504
</pre></div>
</div>
</li>
</ul>
</section>
<section id="loading-programs">
<h2>Loading Programs<a class="headerlink" href="#loading-programs" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#loading-programs'">¶</a></h2>
<ul class="simple">
<li><p>loader allocates memory for executable’s text, data, bss, heap, and
stack. and loads program’s image into memory</p></li>
<li><p>loader gets information from OS where shared libraries are already
allocated in memory and loads the ones that are not already loaded.
each shared library has its own text, data, and bss</p></li>
<li><p>loader goes through executable and adjusts the list of external
symbols to point to the correct spots in memory (to shared libraries)</p></li>
<li><p>try the <code class="docutils literal notranslate"><span class="pre">nm</span></code> command to see the symbols in a compiled object/executable.</p></li>
<li><p>once program is ready, loader invokes <code class="docutils literal notranslate"><span class="pre">_start()</span></code> method</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_start()</span></code> calls <code class="docutils literal notranslate"><span class="pre">_init()</span></code> for each shared library</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_start()</span></code> initializes static constructors of objects defined as
global variables</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_start()</span></code> calls main() and program begins</p></li>
</ul>
</section>
<section id="loading-shared-libraries-so">
<h2>Loading shared libraries (.so)<a class="headerlink" href="#loading-shared-libraries-so" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#loading-shared-libraries-so'">¶</a></h2>
<ul class="simple">
<li><p>Libraries also have a data, bss, and text segment</p></li>
<li><p>Memory references in shared libraries are position independent (GCC
<code class="docutils literal notranslate"><span class="pre">-fpic</span></code> or <code class="docutils literal notranslate"><span class="pre">-fPIC</span></code> flagsA. Newer GCC makes PIC defualt. Use <code class="docutils literal notranslate"><span class="pre">-fno-pic</span></code>
if you notice this.</p></li>
<li><p>Linker must resolve all of these position independent memory accesses
to local accesses. This is accomplished by writing the GOT for each
linked process.</p></li>
<li><p>The need for the memory addresses to be position independent is
because the offset that a shared library will be loaded will differ
between executions of the same program and among other programs.</p></li>
<li><p>Also, the same loaded shared library will be shared with other
processes without reloading. So, the same library may have different
offsets for different programs</p></li>
</ul>
</section>
<section id="more-about-gcc-pic-option">
<h2>more about GCC pic option<a class="headerlink" href="#more-about-gcc-pic-option" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#more-about-gcc-pic-option'">¶</a></h2>
<p>Based on the <em>man page</em> for <code class="docutils literal notranslate"><span class="pre">gcc</span></code></p>
<p>Generate position-independent code (PIC) suitable for use in a shared
library, if supported for the target machine. Such code accesses all
constant addresses through a global offset table (GOT). The dynamic
loader resolves the GOT entries when the program starts (the dynamic
loader is not part of GCC; it is part of the operating system). If the
GOT size for the linked executable exceeds a machine-specific maximum
size, you get an error message from the linker indicating that -fpic
does not work; in that case, recompile with -fPIC instead. (These
maximums are 8k on the SPARC and 32k on the m68k and RS/6000. The 386
has no such limit.)</p>
</section>
<section id="id2">
<h2>Loading shared libraries (.so)<a class="headerlink" href="#id2" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#id2'">¶</a></h2>
<ul class="simple">
<li><p>Static libraries do not contain position independent code</p></li>
<li><p>Static libraries are simply a collection of unlinked <code class="docutils literal notranslate"><span class="pre">.o</span></code> (object)
files</p></li>
<li><p>The dynamic linker simply loads the text, data, and bss sections of
each object file into the program’s address space</p></li>
</ul>
</section>
<section id="position-independent-code-example">
<h2>Position Independent Code Example<a class="headerlink" href="#position-independent-code-example" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#position-independent-code-example'">¶</a></h2>
<ul>
<li><p>Get the code</p>
<p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span> <span class="pre">https://github.com/gkthiruvathukal/systems-code-examples</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">cd</span> <span class="pre">systems-code-examples/pic</span></code></p>
</li>
<li><p>For this example, you can build it using <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">-f</span> <span class="pre">Makefile.pic</span></code>.</p></li>
<li><p>The main purpose of this example is to show the difference between generating PIC vs. non-PIC.</p></li>
</ul>
</section>
<section id="main-cc">
<h2>main.cc<a class="headerlink" href="#main-cc" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#main-cc'">¶</a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"abcdefg"</span><span class="p">;</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="linenos"> 6</span><span class="p">{</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span><span class="w">    </span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="p">}</span>
<span class="linenos">15</span>
</pre></div>
</div>
</section>
<section id="main-nopic-s-non-position-independent-code-gcc-fno-pic">
<h2>main.nopic.s - non-position independent code (gcc -fno-pic)<a class="headerlink" href="#main-nopic-s-non-position-independent-code-gcc-fno-pic" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#main-nopic-s-non-position-independent-code-gcc-fno-pic'">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>	.file	"main.c"
<span class="linenos"> 2</span>	.text
<span class="linenos"> 3</span>	.globl	msg
<span class="linenos"> 4</span>	.section	.rodata
<span class="linenos"> 5</span>.LC0:
<span class="linenos"> 6</span>	.string	"abcdefg"
<span class="linenos"> 7</span>	.data
<span class="linenos"> 8</span>	.align 8
<span class="linenos"> 9</span>	.type	msg, @object
<span class="linenos">10</span>	.size	msg, 8
<span class="linenos">11</span>msg:
<span class="linenos">12</span>	.quad	.LC0
<span class="linenos">13</span>	.text
<span class="linenos">14</span>	.globl	main
<span class="linenos">15</span>	.type	main, @function
<span class="linenos">16</span>main:
<span class="linenos">17</span>.LFB0:
<span class="linenos">18</span>	.cfi_startproc
<span class="linenos">19</span>	endbr64
<span class="linenos">20</span>	pushq	%rbp
<span class="linenos">21</span>	.cfi_def_cfa_offset 16
<span class="linenos">22</span>	.cfi_offset 6, -16
<span class="linenos">23</span>	movq	%rsp, %rbp
<span class="linenos">24</span>	.cfi_def_cfa_register 6
<span class="linenos">25</span>	subq	$32, %rsp
<span class="linenos">26</span>	movl	%edi, -20(%rbp)
<span class="linenos">27</span>	movq	%rsi, -32(%rbp)
<span class="linenos">28</span>	movq	msg(%rip), %rax
<span class="linenos">29</span>	addq	$1, %rax
<span class="linenos">30</span>	movq	%rax, -8(%rbp)
<span class="linenos">31</span>	movq	-8(%rbp), %rax
<span class="linenos">32</span>	movl	$1, %edx
<span class="linenos">33</span>	movq	%rax, %rsi
<span class="linenos">34</span>	movl	$1, %edi
<span class="linenos">35</span>	call	write
<span class="linenos">36</span>	movl	$0, %eax
<span class="linenos">37</span>	leave
<span class="linenos">38</span>	.cfi_def_cfa 7, 8
<span class="linenos">39</span>	ret
</pre></div>
</div>
</section>
<section id="main-nopic-s-position-independent-code-gcc-fpic-default-option">
<h2>main.nopic.s - position independent code (gcc -fpic, default option)<a class="headerlink" href="#main-nopic-s-position-independent-code-gcc-fpic-default-option" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#main-nopic-s-position-independent-code-gcc-fpic-default-option'">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>	.file	"main.c"
<span class="linenos"> 2</span>	.text
<span class="linenos"> 3</span>	.globl	msg
<span class="linenos"> 4</span>	.section	.rodata
<span class="linenos"> 5</span>.LC0:
<span class="linenos"> 6</span>	.string	"abcdefg"
<span class="linenos"> 7</span>	.section	.data.rel.local,"aw"
<span class="linenos"> 8</span>	.align 8
<span class="linenos"> 9</span>	.type	msg, @object
<span class="linenos">10</span>	.size	msg, 8
<span class="linenos">11</span>msg:
<span class="linenos">12</span>	.quad	.LC0
<span class="linenos">13</span>	.text
<span class="linenos">14</span>	.globl	main
<span class="linenos">15</span>	.type	main, @function
<span class="linenos">16</span>main:
<span class="linenos">17</span>.LFB0:
<span class="linenos">18</span>	.cfi_startproc
<span class="linenos">19</span>	endbr64
<span class="linenos">20</span>	pushq	%rbp
<span class="linenos">21</span>	.cfi_def_cfa_offset 16
<span class="linenos">22</span>	.cfi_offset 6, -16
<span class="linenos">23</span>	movq	%rsp, %rbp
<span class="linenos">24</span>	.cfi_def_cfa_register 6
<span class="linenos">25</span>	subq	$32, %rsp
<span class="linenos">26</span>	movl	%edi, -20(%rbp)
<span class="linenos">27</span>	movq	%rsi, -32(%rbp)
<span class="linenos">28</span>	movq	msg@GOTPCREL(%rip), %rax
<span class="linenos">29</span>	movq	(%rax), %rax
<span class="linenos">30</span>	addq	$1, %rax
<span class="linenos">31</span>	movq	%rax, -8(%rbp)
<span class="linenos">32</span>	movq	-8(%rbp), %rax
<span class="linenos">33</span>	movl	$1, %edx
<span class="linenos">34</span>	movq	%rax, %rsi
<span class="linenos">35</span>	movl	$1, %edi
<span class="linenos">36</span>	call	write@PLT
<span class="linenos">37</span>	movl	$0, %eax
<span class="linenos">38</span>	leave
<span class="linenos">39</span>	.cfi_def_cfa 7, 8
<span class="linenos">40</span>	ret
</pre></div>
</div>
</section>
<section id="what-s-the-difference">
<h2>What’s the difference?<a class="headerlink" href="#what-s-the-difference" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#what-s-the-difference'">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">diff</span> <span class="n">main</span><span class="o">.</span><span class="n">pic</span><span class="o">.</span><span class="n">s</span> <span class="n">main</span><span class="o">.</span><span class="n">nopic</span><span class="o">.</span><span class="n">s</span>
<span class="linenos"> 2</span><span class="mi">7</span><span class="n">c7</span>
<span class="linenos"> 3</span><span class="o">&lt;</span> 	<span class="o">.</span><span class="n">section</span>	<span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">local</span><span class="p">,</span><span class="s2">"aw"</span>
<span class="linenos"> 4</span><span class="o">---</span>
<span class="linenos"> 5</span><span class="o">&gt;</span> 	<span class="o">.</span><span class="n">data</span>
<span class="linenos"> 6</span><span class="mi">28</span><span class="p">,</span><span class="mi">29</span><span class="n">c28</span>
<span class="linenos"> 7</span><span class="o">&lt;</span> 	<span class="n">movq</span>	<span class="n">msg</span><span class="nd">@GOTPCREL</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span> <span class="o">%</span><span class="n">rax</span>
<span class="linenos"> 8</span><span class="o">&lt;</span> 	<span class="n">movq</span>	<span class="p">(</span><span class="o">%</span><span class="n">rax</span><span class="p">),</span> <span class="o">%</span><span class="n">rax</span>
<span class="linenos"> 9</span><span class="o">---</span>
<span class="linenos">10</span><span class="o">&gt;</span> 	<span class="n">movq</span>	<span class="n">msg</span><span class="p">(</span><span class="o">%</span><span class="n">rip</span><span class="p">),</span> <span class="o">%</span><span class="n">rax</span>
<span class="linenos">11</span><span class="mi">36</span><span class="n">c35</span>
<span class="linenos">12</span><span class="o">&lt;</span> 	<span class="n">call</span>	<span class="n">write</span><span class="nd">@PLT</span>
<span class="linenos">13</span><span class="o">---</span>
<span class="linenos">14</span><span class="o">&gt;</span> 	<span class="n">call</span>	<span class="n">write</span>
</pre></div>
</div>
</section>
<section id="shared-libraries-evaluation">
<h2>Shared Libraries - Evaluation<a class="headerlink" href="#shared-libraries-evaluation" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#shared-libraries-evaluation'">¶</a></h2>
<p>Strengths</p>
<ul class="simple">
<li><p>Reduced memory footprint. If two programs load the same shared
library, the .text segment is reused across processes thanks to the
GOT</p></li>
</ul>
<p>Weaknesses</p>
<ul class="simple">
<li><p>Requires a more advanced virtual memory implementation in the
operating system. Sometimes not practical for simple or embedded
systems</p></li>
<li><p>Requires more advanced compiler code generators. Different processors
have special features regarding memory offset registers or function
table size limitations.</p></li>
</ul>
</section>
<section id="static-libraries-evaluation">
<h2>Static Libraries - Evaluation<a class="headerlink" href="#static-libraries-evaluation" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#static-libraries-evaluation'">¶</a></h2>
<p>Strengths</p>
<ul class="simple">
<li><p>Makes sense when re-use is not desired. A good example would be
installer executables with very large .data segments.</p></li>
<li><p>Faster first load loading time than shared libraries.</p></li>
<li><p>Fewer instructions generated for GOT lookups (minor issue)</p></li>
</ul>
<p>Weaknesses</p>
<ul class="simple">
<li><p>Much larger memory footprint. Little reuse of common code between
applications.</p></li>
</ul>
</section>
<section id="libraries-vs-statically-linked-programs">
<h2>Libraries vs. Statically-Linked Programs<a class="headerlink" href="#libraries-vs-statically-linked-programs" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#libraries-vs-statically-linked-programs'">¶</a></h2>
<p>Dynamic Linking advantages:</p>
<ul class="simple">
<li><p>Memory footprint</p></li>
<li><p>Code reuse</p></li>
<li><p>Improvement with new versions of shared libraries</p></li>
<li><p>Smaller executables</p></li>
</ul>
<p>Static linking advantages:</p>
<ul class="simple">
<li><p>When deploying software, dependencies are less of a concern (e.g.
missing dependencies, incorrectly upgraded dependencies, custom
patches and alterations to shared code)</p></li>
<li><p>Versioning and path problems are less of a concern</p></li>
<li><p>Code obfuscation can obfuscate across object files</p></li>
<li><p>Compiler optimizers can optimize across object files</p></li>
</ul>
</section>
<section id="process-protection">
<h2>Process Protection<a class="headerlink" href="#process-protection" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#process-protection'">¶</a></h2>
<p>In modern operating systems with virtual memory and privileged
separation the following protections are afforded:</p>
<ul class="simple">
<li><p>One process cannot read the memory of another process (except when
explicitly permitted)</p></li>
<li><p>A process can fully manage the memory that it can access - garbage
collection, explicit allocation/deallocation, method call and
parameter passing standards, stack management, etc.</p></li>
<li><p>A crash, exception, resource starvation, deadlock, or other fault in
one process does not directly affect other processes</p></li>
<li><p>While mapped to the same address space, the process cannot modify
kernel memory or memory otherwise protected by the operating system
(such as text pages).</p></li>
</ul>
</section>
<section id="process-creation-with-fork">
<h2>Process Creation with fork()<a class="headerlink" href="#process-creation-with-fork" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#process-creation-with-fork'">¶</a></h2>
<p>From the <code class="docutils literal notranslate"><span class="pre">fork()</span></code> man page:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fork()</span></code> creates a new process by duplicating the calling process.
The new process, referred to as the child, is an exact duplicate of the calling process,
referred to as the parent, except for the following points:</p></li>
<li><p>the child has its own unique process id (PID)</p></li>
<li><p>the child’s parent PID is the same as the parent’s PID</p></li>
<li><p>the parent’s threads are not recreated on the child</p></li>
</ul>
<p>interesting point: in Linux, <code class="docutils literal notranslate"><span class="pre">fork()</span> <span class="pre">!=</span> <span class="pre">fork()</span></code>; <code class="docutils literal notranslate"><span class="pre">fork()</span></code> calls <code class="docutils literal notranslate"><span class="pre">clone()</span></code></p>
<p>From the man page:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fork()</span></code> returns the child PID to the parent</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fork()</span></code> returns 0 to the child</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fork()</span></code> returns -1 if the child cannot be created</p></li>
</ul>
</section>
<section id="fork-example">
<h2>fork() example<a class="headerlink" href="#fork-example" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#fork-example'">¶</a></h2>
<p>See <code class="docutils literal notranslate"><span class="pre">systems-code-examples/fork</span></code> if you want to run this program.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd systems-code-examples/fork
$ cmake
$ make
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="linenos"> 7</span><span class="p">{</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">SomeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="s">"test_file"</span><span class="p">,</span><span class="w"> </span><span class="n">O_WRONLY</span><span class="o">|</span><span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_TRUNC</span><span class="p">,</span><span class="w"> </span><span class="mo">0666</span><span class="p">);</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">parentMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"1111111"</span><span class="p">;</span>
<span class="linenos">13</span><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">childMessage</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="s">"22222222222222</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<span class="linenos">14</span>
<span class="linenos">15</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">16</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">17</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"hello from the parent process, chid pid = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span>
<span class="linenos">18</span><span class="w">        </span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="linenos">19</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"parent's SomeValue = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">SomeValue</span><span class="p">);</span>
<span class="linenos">20</span><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">parentMessage</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">parentMessage</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
<span class="linenos">21</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">22</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">23</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">24</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"hello from the child process</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="linenos">25</span><span class="w">        </span><span class="n">SomeValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">;</span>
<span class="linenos">26</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"child's SomeValue = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">SomeValue</span><span class="p">);</span>
<span class="linenos">27</span><span class="w">        </span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">childMessage</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">childMessage</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
<span class="linenos">28</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">29</span><span class="w">    </span><span class="k">else</span>
<span class="linenos">30</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">31</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"fork() failed!!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="linenos">32</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos">37</span><span class="p">}</span>
<span class="linenos">38</span>
<span class="linenos">39</span>
</pre></div>
</div>
</section>
<section id="process-creation-with-clone">
<h2>Process Creation with clone()<a class="headerlink" href="#process-creation-with-clone" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#process-creation-with-clone'">¶</a></h2>
<ul class="simple">
<li><p>similar to <code class="docutils literal notranslate"><span class="pre">fork()</span></code> in that a child process is created.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clone()</span></code> allows different parts of the parent process to be shared
with the child process</p></li>
<li><p>flags for creating a light weight process (kernel thread):</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">CLONE_FS</span></code> - share FS information (chroot, chdir, umask)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CLONE_FILES</span></code> - share file descriptor table</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CLONE_SIGHAND</span></code> - share signal handlers</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CLONE_VM</span></code> - share page table</p></li>
</ul>
</li>
<li><p>many more flags exist - don’t forget this little known capability!</p></li>
<li><p>glibc’s version of <code class="docutils literal notranslate"><span class="pre">fork()</span></code>, calls <code class="docutils literal notranslate"><span class="pre">clone()</span></code> without any of these flags</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clone()</span></code> not present in every UNIX OS (available in Linux but not
Minix)</p></li>
</ul>
</section>
<section id="windows-createprocess-and-createthread">
<h2>Windows CreateProcess() and CreateThread()<a class="headerlink" href="#windows-createprocess-and-createthread" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#windows-createprocess-and-createthread'">¶</a></h2>
<ul class="simple">
<li><p>Different from UNIX <code class="docutils literal notranslate"><span class="pre">fork()</span></code>/<code class="docutils literal notranslate"><span class="pre">clone()</span></code> - parts of processes are not
shared</p></li>
<li><p>Windows has two flavors:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">CreateProcess()</span></code> - creates a new process, equivalent of calling
<code class="docutils literal notranslate"><span class="pre">fork()</span></code> then <code class="docutils literal notranslate"><span class="pre">execve()</span></code> in UNIX</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CreateThread()</span></code> - equivalent of creating <code class="docutils literal notranslate"><span class="pre">clone()</span></code> with thread flags</p></li>
</ul>
</li>
<li><p>Is this a disadvantage?</p>
<ul>
<li><p>For most use cases and most programs, no.</p></li>
<li><p>The vast majority of calls to <code class="docutils literal notranslate"><span class="pre">clone()</span></code> in UNIX are equivalent to
<code class="docutils literal notranslate"><span class="pre">CreateThread()</span></code></p></li>
<li><p>The vast majority of calls to <code class="docutils literal notranslate"><span class="pre">fork()</span></code> in UNIX are equivalent to
<code class="docutils literal notranslate"><span class="pre">CreateProcess()</span></code></p></li>
</ul>
</li>
</ul>
</section>
<section id="emulating-fork-on-windows">
<h2>Emulating fork() on Windows<a class="headerlink" href="#emulating-fork-on-windows" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#emulating-fork-on-windows'">¶</a></h2>
<p>A well known system, Cygwin, implements <code class="docutils literal notranslate"><span class="pre">fork()</span></code> on Windows as follows:</p>
<ol class="arabic simple">
<li><p>cygwin.dll calls <code class="docutils literal notranslate"><span class="pre">CreateProcess()</span></code> to create a suspended child process</p></li>
<li><p>parent process calls <code class="docutils literal notranslate"><span class="pre">setjmp()</span></code> to save registers</p></li>
<li><p>parent process copies its BSS and DATA sections to the child’s
address space.</p></li>
<li><p>parent wakes child up and waits on a named mutex (mutual exclusion mechanism).</p></li>
<li><p>child wakes up, realizes it was a forked process, then longjumps to
the saved jump buffer. child unlock’s</p></li>
<li><p>parent’s named mutex and waits on a second mutex</p></li>
<li><p>parent wakes up, copies its stack and heap to the child process.
release’s child’s named mutex</p></li>
<li><p>Child wakes up and copies any memory mapped regions the parent
signals to the child through shared memory</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fork()</span></code> system call in Cygwin does not use copy on write, but “copy on
fork”. this is similar to <code class="docutils literal notranslate"><span class="pre">fork()</span></code> implementations in early UNIX
operating systems</p></li>
</ol>
</section>
<section id="causes-of-process-termination">
<h2>Causes of process termination<a class="headerlink" href="#causes-of-process-termination" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#causes-of-process-termination'">¶</a></h2>
<ul class="simple">
<li><p>Normal exit–return from <code class="docutils literal notranslate"><span class="pre">main(...)</span></code></p></li>
<li><p>Error exit–return from <code class="docutils literal notranslate"><span class="pre">main(...)</span></code> with an error code</p></li>
<li><p>Fatal error</p>
<ul>
<li><p>segfault/bus error–process tries to read/write inaccessible memory
or write to read-only memory.</p></li>
<li><p>stack overflow–stack pointer grows to larger than stack area</p></li>
<li><p>protection fault–trying to run privileged instructions such as
enabling/disabling interrupts</p></li>
<li><p>instruction faults–divide by zero</p></li>
</ul>
</li>
<li><p>External termination by another process either through signals or
system calls</p></li>
</ul>
</section>
<section id="wait-and-waitpid-examples">
<h2>wait() and waitpid() examples<a class="headerlink" href="#wait-and-waitpid-examples" title="Link to this heading" x-intersect.margin.0%.0%.-70%.0%="activeSection = '#wait-and-waitpid-examples'">¶</a></h2>
<p>See <code class="docutils literal notranslate"><span class="pre">systems-code-examples/wait</span></code> if you want to run this program.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/types.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/wait.h&gt;</span>
<span class="linenos"> 3</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="linenos"> 4</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="linenos"> 5</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="linenos"> 9</span><span class="p">{</span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">pid_t</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
<span class="linenos">11</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="linenos">12</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">13</span><span class="w">        </span><span class="n">abort</span><span class="p">();</span><span class="w">    </span><span class="c1">//child process exits</span>
<span class="linenos">14</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">15</span><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span><span class="w"> </span><span class="c1">// wait for child to exit</span>
<span class="linenos">17</span><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
<span class="linenos">18</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">19</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"normal exit. exit code = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
<span class="linenos">20</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">21</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">WIFSIGNALED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
<span class="linenos">22</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">23</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"abnormal termination, signal number = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">WTERMSIG</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
<span class="linenos">24</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">25</span><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">WIFSTOPPED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
<span class="linenos">26</span><span class="w">    </span><span class="p">{</span>
<span class="linenos">27</span><span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">"child stopped, signal number = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">WSTOPSIG</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
<span class="linenos">28</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">29</span><span class="p">}</span>
<span class="linenos">30</span>
<span class="linenos">31</span>
</pre></div>
</div>
</section>
</section>
</div></div><aside class="hidden text-sm xl:block" id="right-sidebar">
<div class="sticky top-16 -mt-10 max-h-[calc(var(--vh)-4rem)] overflow-y-auto pt-6 space-y-2"><p class="font-medium">On this page</p>
<ul>
<li><a :data-current="activeSection === '#process-memory-layout'" class="reference internal" href="#process-memory-layout">Process Memory Layout</a></li>
<li><a :data-current="activeSection === '#id1'" class="reference internal" href="#id1">Process Memory Layout</a></li>
<li><a :data-current="activeSection === '#multithreaded-memory-layout'" class="reference internal" href="#multithreaded-memory-layout">Multithreaded Memory Layout</a></li>
<li><a :data-current="activeSection === '#preliminaries'" class="reference internal" href="#preliminaries">Preliminaries</a></li>
<li><a :data-current="activeSection === '#examine-process-layout-example'" class="reference internal" href="#examine-process-layout-example">Examine Process Layout Example</a></li>
<li><a :data-current="activeSection === '#loading-programs'" class="reference internal" href="#loading-programs">Loading Programs</a></li>
<li><a :data-current="activeSection === '#loading-shared-libraries-so'" class="reference internal" href="#loading-shared-libraries-so">Loading shared libraries (.so)</a></li>
<li><a :data-current="activeSection === '#more-about-gcc-pic-option'" class="reference internal" href="#more-about-gcc-pic-option">more about GCC pic option</a></li>
<li><a :data-current="activeSection === '#id2'" class="reference internal" href="#id2">Loading shared libraries (.so)</a></li>
<li><a :data-current="activeSection === '#position-independent-code-example'" class="reference internal" href="#position-independent-code-example">Position Independent Code Example</a></li>
<li><a :data-current="activeSection === '#main-cc'" class="reference internal" href="#main-cc">main.cc</a></li>
<li><a :data-current="activeSection === '#main-nopic-s-non-position-independent-code-gcc-fno-pic'" class="reference internal" href="#main-nopic-s-non-position-independent-code-gcc-fno-pic">main.nopic.s - non-position independent code (gcc -fno-pic)</a></li>
<li><a :data-current="activeSection === '#main-nopic-s-position-independent-code-gcc-fpic-default-option'" class="reference internal" href="#main-nopic-s-position-independent-code-gcc-fpic-default-option">main.nopic.s - position independent code (gcc -fpic, default option)</a></li>
<li><a :data-current="activeSection === '#what-s-the-difference'" class="reference internal" href="#what-s-the-difference">What’s the difference?</a></li>
<li><a :data-current="activeSection === '#shared-libraries-evaluation'" class="reference internal" href="#shared-libraries-evaluation">Shared Libraries - Evaluation</a></li>
<li><a :data-current="activeSection === '#static-libraries-evaluation'" class="reference internal" href="#static-libraries-evaluation">Static Libraries - Evaluation</a></li>
<li><a :data-current="activeSection === '#libraries-vs-statically-linked-programs'" class="reference internal" href="#libraries-vs-statically-linked-programs">Libraries vs. Statically-Linked Programs</a></li>
<li><a :data-current="activeSection === '#process-protection'" class="reference internal" href="#process-protection">Process Protection</a></li>
<li><a :data-current="activeSection === '#process-creation-with-fork'" class="reference internal" href="#process-creation-with-fork">Process Creation with fork()</a></li>
<li><a :data-current="activeSection === '#fork-example'" class="reference internal" href="#fork-example">fork() example</a></li>
<li><a :data-current="activeSection === '#process-creation-with-clone'" class="reference internal" href="#process-creation-with-clone">Process Creation with clone()</a></li>
<li><a :data-current="activeSection === '#windows-createprocess-and-createthread'" class="reference internal" href="#windows-createprocess-and-createthread">Windows CreateProcess() and CreateThread()</a></li>
<li><a :data-current="activeSection === '#emulating-fork-on-windows'" class="reference internal" href="#emulating-fork-on-windows">Emulating fork() on Windows</a></li>
<li><a :data-current="activeSection === '#causes-of-process-termination'" class="reference internal" href="#causes-of-process-termination">Causes of process termination</a></li>
<li><a :data-current="activeSection === '#wait-and-waitpid-examples'" class="reference internal" href="#wait-and-waitpid-examples">wait() and waitpid() examples</a></li>
</ul>
</div>
</aside>
</main>
</div>
</div><footer class="py-6 border-t border-border md:py-0">
<div class="container flex flex-col items-center justify-between gap-4 md:h-24 md:flex-row">
<div class="flex flex-col items-center gap-4 px-8 md:flex-row md:gap-2 md:px-0">
<p class="text-sm leading-loose text-center text-muted-foreground md:text-left">© 2013-2020, Operating Systems Faculty at Loyola University Chicago Built with <a class="font-medium underline underline-offset-4" href="https://www.sphinx-doc.org" rel="noreferrer">Sphinx 7.2.6</a></p>
</div>
</div>
</footer>
</div>
</body>
</html>